-- version:0.2 --date:27/04/2015 desc:show all forms type,ampere rating,location,powefactor(LCE_TENDER_ITEM_PRICE_DETAILS table) --done by:rl
-- ver0.1 date:04/04/2015 desc: sp to show all forms type,ampere rating,location,powefactor and brand done by:dhivya


DROP PROCEDURE IF EXISTS SP_VIEW_TYPE_LOCATION;
CREATE PROCEDURE SP_VIEW_TYPE_LOCATION(
IN TMID INTEGER,
IN USERSTAMP VARCHAR(50),
OUT TEMPTABLE TEXT)

BEGIN

	DECLARE TEMP_TABLE TEXT;
	DECLARE USERSTAMP_ID INTEGER;
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	    BEGIN 
		ROLLBACK; 
	END;
	START TRANSACTION;

	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	SET AUTOCOMMIT = 0;

	SET TEMP_TABLE=(SELECT CONCAT('TEMP_VIEW_TYPE_LOCATION',SYSDATE()));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
	SET TEMPTABLE=(SELECT CONCAT(TEMP_TABLE,'_',USERSTAMP_ID));

	SET @DROP_QUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPTABLE));
	PREPARE DROP_QUERY_STMT FROM @DROP_QUERY;
	EXECUTE DROP_QUERY_STMT;

	SET @CREATE_QUERY=(SELECT CONCAT('CREATE TABLE ',TEMPTABLE,'(
	ID INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,
	TYPE VARCHAR(60),
	TYPE_DATA VARCHAR(100),
	TYPE_SUBDATA VARCHAR(20),
	AMPERE_RATING VARCHAR(30),
	AR_DATA VARCHAR(60),
	POWER_FACTOR VARCHAR(50),
	PF_DATA VARCHAR(50),
	BRAND VARCHAR(50),
	BRAND_DATA VARCHAR(50),
	DESCRIPTION VARCHAR(50),
	DESC_DATA VARCHAR(100),
	FROM_LOCATION VARCHAR(60),
	TO_LOCATION VARCHAR(60))'));
	PREPARE CREATE_QUERY_STMT FROM @CREATE_QUERY;
	EXECUTE CREATE_QUERY_STMT;

	SET MINID=2;
	SET MAXID=30;

	WHILE MINID<=MAXID DO  
	
	-- TYPE
	SELECT DISTINCT CT_DATA,CT_SUBDATA,L1.CT_ID INTO @CTDATA,@CTSUBDATA,@CTID FROM LCE_TENDER_SUMMARY_DETAILS L1,
	LCE_CABLING_TYPE CT WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.CT_ID=CT.CT_ID;
	SELECT TSI_ITEMS INTO @CTITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_CABLING_TYPE WHERE CT_ID=@CTID) AND TSI_FLAG='XX' ;

	SELECT DISTINCT CT_DATA,CT_SUBDATA,L1.CT_ID INTO @CTDATA,@CTSUBDATA,@CTID FROM LCE_TENDER_SUMMARY_DETAILS L1,
	LCE_CABLING_TYPE CT WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.CT_ID=CT.CT_ID;
	SELECT TSI_ITEMS INTO @CTITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_CABLING_TYPE WHERE CT_ID=@CTID) AND TSI_FLAG='XX' ;

	-- AMPERE RATING
	SELECT DISTINCT AR_DATA,L1.AR_ID INTO @ARDATA,@ARID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_AMPERE_RATING AR WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.AR_ID=AR.AR_ID;
	SELECT TSI_ITEMS INTO @ARITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_AMPERE_RATING WHERE AR_ID=@ARID) AND TSI_FLAG='XX';

	SELECT DISTINCT AR_DATA,L1.AR_ID INTO @ARDATA,@ARID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_AMPERE_RATING AR WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.AR_ID=AR.AR_ID;
	SELECT TSI_ITEMS INTO @ARITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_AMPERE_RATING WHERE AR_ID=@ARID) AND TSI_FLAG='XX';
	
	-- DESCRIPTION
	SELECT DISTINCT ID_DATA,L1.ID_ID INTO @IDDATA,@ID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_ITEM_DESCRIPTION ID WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.ID_ID=ID.ID_ID;
 	SELECT TSI_ITEMS INTO @IDITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_ITEM_DESCRIPTION WHERE ID_ID=@ID) AND TSI_FLAG='XX';

 	SELECT DISTINCT ID_DATA,L1.ID_ID INTO @IDDATA,@ID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_ITEM_DESCRIPTION ID WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.ID_ID=ID.ID_ID;
 	SELECT TSI_ITEMS INTO @IDITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_ITEM_DESCRIPTION WHERE ID_ID=@ID) AND TSI_FLAG='XX';

 	-- POWER FACTOR
 	SELECT DISTINCT PF_DATA,L1.PF_ID INTO @PFDATA,@PFID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_POWER_FACTOR PF WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.PF_ID=PF.PF_ID;
 	SELECT TSI_ITEMS INTO @PFITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_POWER_FACTOR WHERE PF_ID=@PFID) AND TSI_FLAG='XX';

 	SELECT DISTINCT PF_DATA,L1.PF_ID INTO @PFDATA,@PFID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_POWER_FACTOR PF WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.PF_ID=PF.PF_ID;
 	SELECT TSI_ITEMS INTO @PFITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_POWER_FACTOR WHERE PF_ID=@PFID) AND TSI_FLAG='XX';

 	-- BRAND
 	SELECT DISTINCT IB_DATA,L1.IB_ID INTO @IBDATA,@IBID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_ITEM_BRAND IB WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.IB_ID=IB.IB_ID;
 	SELECT TSI_ITEMS INTO @IBITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_ITEM_BRAND WHERE IB_ID=@IBID) AND TSI_FLAG='XX';

 	SELECT DISTINCT IB_DATA,L1.IB_ID INTO @IBDATA,@IBID FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_ITEM_BRAND IB WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.IB_ID=IB.IB_ID;
 	SELECT TSI_ITEMS INTO @IBITEMS FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=(SELECT TSI_ID FROM LCE_ITEM_BRAND WHERE IB_ID=@IBID) AND TSI_FLAG='XX';

 	-- LOCATION

 	SELECT DISTINCT PL_LOCATION INTO @FROMLOC FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_PROJECT_LOCATION L2 WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.TMD_FROM_LOCATION=L2.PL_ID;
 	SELECT DISTINCT PL_LOCATION INTO @TOLOC FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_PROJECT_LOCATION L2 WHERE L1.IPD_ID IN (SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.TMD_TO_LOCATION=L2.PL_ID;

 	SELECT DISTINCT PL_LOCATION INTO @FROMLOC FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_PROJECT_LOCATION L2 WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.TMD_FROM_LOCATION=L2.PL_ID;
 	SELECT DISTINCT PL_LOCATION INTO @TOLOC FROM LCE_TENDER_SUMMARY_DETAILS L1,LCE_PROJECT_LOCATION L2 WHERE L1.TIPD_ID IN (SELECT TIPD_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE TI_ID=MINID) AND L1.TM_ID=TMID AND L1.TMD_TO_LOCATION=L2.PL_ID;

 	SET @INSERT_QUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLE,'(ID,
 	TYPE,TYPE_DATA,TYPE_SUBDATA,AMPERE_RATING,AR_DATA,POWER_FACTOR,PF_DATA,BRAND,BRAND_DATA,DESCRIPTION,DESC_DATA,FROM_LOCATION,TO_LOCATION)
 	VALUES(',MINID,',@CTITEMS,@CTDATA,@CTSUBDATA,@ARITEMS,@ARDATA,@PFITEMS,@PFDATA,@IBITEMS,@IBDATA,@IDITEMS,@IDDATA,@FROMLOC,@TOLOC)'));
 	 PREPARE INSERT_QUERY_STMT FROM @INSERT_QUERY;
 	 EXECUTE INSERT_QUERY_STMT;

 	SET @CTITEMS='';
 	SET @CTDATA='';SET @CTSUBDATA='';SET @ARITEMS='';SET @ARDATA='';
 	SET @PFITEMS='';SET @PFDATA='';SET @IBITEMS='';SET @IBDATA='';
 	SET @IDITEMS='';SET @IDDATA='';SET @FROMLOC='';SET @TOLOC='';
 	SET @CTID='';SET @ARID='';SET @ID='';SET @PFID='';SET @IBID='';

 	SET MINID=MINID+1;

END WHILE;

COMMIT;

END;
