-- VER0.3 DATE:04/05/2015 DESC: ADDED COUNT FOR EXTRA ENTERED ITEMS FROM LCE_TENDER_ITEM_PRICE_DETAILS;
-- VER:0.2 DATE:11/04/2015 DESC:IPD_SNO GET FROM ITEM PRICE DETAILS TABLE --DONE BY:RL
-- VER0.1 DATE:24/03/2015 DESC:SP TO SHOW COUNT WHICH R THE FORMS ENTERED & NOT ENTERED done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_ENTER_NON_ENTER_PROJECT_COUNT;
CREATE PROCEDURE SP_LCE_ENTER_NON_ENTER_PROJECT_COUNT(
IN TMID INTEGER,
IN USERSTAMP VARCHAR(50),
OUT FINAL_TABLENAME TEXT)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);

	DECLARE TEMP_LCE_TENDERITEMS_DTLS TEXT;
	DECLARE MIN_TI_ID INTEGER;
	DECLARE MAX_TI_ID INTEGER;
	DECLARE TENDER_ITEM_COUNT INTEGER;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
		IF(TEMP_LCE_TENDERITEMS_DTLS IS NOT NULL) THEN
			SET @TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_LCE_TENDERITEMS_DTLS));
			PREPARE TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY_STMT FROM @TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY;
			EXECUTE TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY_STMT;
		END IF;
	END;
	
	START TRANSACTION;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));

	SET TEMP_LCE_TENDERITEMS_DTLS=(SELECT CONCAT('TEMP_LCE_TENDERITEMS_DETAILS','_',SYSDATEANDULDID));

	SET @CREATE_TEMP_LCE_TENDERITEMS_DTLS = (SELECT CONCAT('CREATE TABLE ',TEMP_LCE_TENDERITEMS_DTLS,' (
	ID INTEGER AUTO_INCREMENT,
	IPD_ID INTEGER,
	TMD_SNO VARCHAR(10),
	TI_ID INTEGER,
	PRIMARY KEY(ID))'));
	PREPARE CREATE_TEMP_LCE_TENDERITEMS_DTLS_STMT FROM @CREATE_TEMP_LCE_TENDERITEMS_DTLS;
	EXECUTE CREATE_TEMP_LCE_TENDERITEMS_DTLS_STMT;

	SET @INSERT_TEMP_LCE_TENDERITEMS_DTLS = (SELECT CONCAT('INSERT INTO ',TEMP_LCE_TENDERITEMS_DTLS,'
	(IPD_ID,TMD_SNO,TI_ID) SELECT TMD.IPD_ID,IPD.IPD_SNO,IPD.TI_ID FROM LCE_TENDER_SUMMARY_DETAILS TMD,
	LCE_ITEM_PRICE_DETAILS IPD WHERE IPD.IPD_ID = TMD.IPD_ID AND TM_ID = ',TMID,' ORDER BY IPD.IPD_ID ASC'));
	PREPARE INSERT_TEMP_LCE_TENDERITEMS_DTLS_STMT FROM @INSERT_TEMP_LCE_TENDERITEMS_DTLS;
	EXECUTE INSERT_TEMP_LCE_TENDERITEMS_DTLS_STMT;

	SET @INSERT_TEMP_LCE_TENDERITEMS_DTLS = (SELECT CONCAT('INSERT INTO ',TEMP_LCE_TENDERITEMS_DTLS,'
	(IPD_ID,TMD_SNO,TI_ID) SELECT TIPD_ID,TIPD_SNO,TI_ID FROM LCE_TENDER_ITEM_PRICE_DETAILS WHERE
	 TM_ID = ',TMID));
	PREPARE INSERT_TEMP_LCE_TENDERITEMS_DTLS_STMT FROM @INSERT_TEMP_LCE_TENDERITEMS_DTLS;
	EXECUTE INSERT_TEMP_LCE_TENDERITEMS_DTLS_STMT;

	SET FINAL_TABLENAME = (SELECT CONCAT('TEMP_ENTER_NON_ENTER_PROJECT_COUNT_DETAILS','_',SYSDATEANDULDID));

	SET @CREATE_FINAL_TABLENAME = (SELECT CONCAT('CREATE TABLE ',FINAL_TABLENAME,'
	(ID INTEGER AUTO_INCREMENT,
	TI_ID INTEGER,
	TI_ITEMS VARCHAR(60),
	TI_COUNT INTEGER,
	PRIMARY KEY(ID))'));
	PREPARE CREATE_FINAL_TABLENAME_STMT FROM @CREATE_FINAL_TABLENAME;
	EXECUTE CREATE_FINAL_TABLENAME_STMT;

	SET @INSERT_FINAL_TABLENAME = (SELECT CONCAT('INSERT INTO ',FINAL_TABLENAME,' (TI_ID,TI_ITEMS)
	SELECT TI_ID,TI_ITEMS FROM LCE_TENDER_ITEMS'));
	PREPARE INSERT_FINAL_TABLENAME_STMT FROM @INSERT_FINAL_TABLENAME;
	EXECUTE INSERT_FINAL_TABLENAME_STMT;

	SET @MINTIID = (SELECT CONCAT('SELECT MIN(TI_ID) INTO @MIN_TIID FROM ',FINAL_TABLENAME,''));
	PREPARE MINTIID_STMT FROM @MINTIID;
	EXECUTE MINTIID_STMT;

	SET @MAXTIID = (SELECT CONCAT('SELECT MAX(TI_ID) INTO @MAX_TIID FROM ',FINAL_TABLENAME,''));
	PREPARE MAXTIID_STMT FROM @MAXTIID;
	EXECUTE MAXTIID_STMT;

	SET MIN_TI_ID = @MIN_TIID;
	SET MAX_TI_ID = @MAX_TIID;

	WHILE(MIN_TI_ID <= MAX_TI_ID) DO 

		SET @TENDERITEMCOUNT = (SELECT CONCAT('SELECT COUNT(*) INTO @TENDER_ITEMCOUNT FROM ',TEMP_LCE_TENDERITEMS_DTLS,'
		WHERE TI_ID = ',MIN_TI_ID,''));
		PREPARE TENDERITEMCOUNT_STMT FROM @TENDERITEMCOUNT;
		EXECUTE TENDERITEMCOUNT_STMT;

		SET TENDER_ITEM_COUNT = @TENDER_ITEMCOUNT;

		SET @UPDATEQUERY = (SELECT CONCAT('UPDATE ',FINAL_TABLENAME,' SET TI_COUNT = ',TENDER_ITEM_COUNT,' 
		WHERE TI_ID = ',MIN_TI_ID,''));
		PREPARE UPDATEQUERY_STMT FROM @UPDATEQUERY;
		EXECUTE UPDATEQUERY_STMT;

		SET MIN_TI_ID = MIN_TI_ID+1;

	END WHILE;

	IF(TEMP_LCE_TENDERITEMS_DTLS IS NOT NULL) THEN
		SET @TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_LCE_TENDERITEMS_DTLS));
		PREPARE TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY_STMT FROM @TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY;
		EXECUTE TEMP_LCE_TENDERITEMS_DTLS_DROPQUERY_STMT;
	END IF;

END;

/*
CALL SP_LCE_ENTER_NON_ENTER_PROJECT_COUNT(1,'admin',@FINALTABLENAME);
select @FINALTABLENAME;
*/