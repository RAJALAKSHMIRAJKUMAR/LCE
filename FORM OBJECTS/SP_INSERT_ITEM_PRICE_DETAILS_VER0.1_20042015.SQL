-- VER0.1 DATE:21/04/2015 DESC: SP TO INSERT DATAS IN ITEM PRICE DETAILS DONE BY:DHIVYA

DROP PROCEDURE IF EXISTS SP_INSERT_ITEM_PRICE_DETAILS;
CREATE PROCEDURE SP_INSERT_ITEM_PRICE_DETAILS(
PTID INTEGER, 
TSIID INTEGER,
DESCRIPTION TEXT,
MATERIAL_COST DECIMAL(10,2),
WIRING_COST DECIMAL(10,2),
LABOUR_COST DECIMAL(10,2),
CABLE_PRICE INTEGER,
UNIT_RATE DECIMAL(10,2),
USERSTAMP VARCHAR(50),
OUT SUCCESS_FLAG INTEGER
)
BEGIN
DECLARE IPDID INTEGER;
DECLARE SNO  VARCHAR(10);
DECLARE F_SNO VARCHAR(10);
DECLARE FINAL_SNO VARCHAR(10);
DECLARE LOC INTEGER;
DECLARE ID INTEGER;
DECLARE S_SNO INTEGER;
DECLARE ID_SNO INTEGER;
DECLARE L_SNO VARCHAR(10);
DECLARE FI_SNO VARCHAR(10);
DECLARE TIID INTEGER;
DECLARE ULDID INTEGER;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
	ROLLBACK;
	SET SUCCESS_FLAG=0;
END;
START TRANSACTION;
SET AUTOCOMMIT=0;
SET SUCCESS_FLAG=0;

IF MATERIAL_COST='' THEN
	SET MATERIAL_COST=NULL;
END IF;
IF LABOUR_COST='' THEN
	SET LABOUR_COST=NULL;
END IF;
IF WIRING_COST='' THEN
	SET WIRING_COST=NULL;
END IF;
IF CABLE_PRICE='' THEN
	SET CABLE_PRICE=NULL;
END IF;
IF UNIT_RATE='' THEN
	SET UNIT_RATE=NULL;
END IF;

SET ULDID=(SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME=USERSTAMP);
SET IPDID=(SELECT MAX(IPD_ID) FROM LCE_ITEM_PRICE_DETAILS WHERE PT_ID=PTID AND TSI_ID=TSIID);
SET SNO=(SELECT IPD_SNO FROM LCE_ITEM_PRICE_DETAILS WHERE IPD_ID=IPDID);

IF TSIID NOT BETWEEN 45 AND 50 THEN
	SET LOC=(SELECT LOCATE('.',SNO,(select LOCATE('.',SNO))+1));  
	SET F_SNO=(SELECT SUBSTRING(SNO,1,(LOC-1)));
	SET ID=(SELECT SUBSTRING(SNO,(LOC+1))+1);
	SET FINAL_SNO=(SELECT CONCAT(F_SNO,'.',ID));
END IF;
IF TSIID BETWEEN 45 AND 50 THEN
	SET LOC=(SELECT LOCATE('.',SNO,(select LOCATE('.',SNO))+1));  
	SET F_SNO=(SELECT SUBSTRING(SNO,1,(LOC-1)));
	SET @AA=F_SNO;
	SET FI_SNO=(SELECT SUBSTRING(SNO,(LOC+1)));
		SET @BB=FI_SNO;
	SET S_SNO=(SELECT LOCATE('.',FI_SNO,1));
		SET @CC=S_SNO;
	SET ID_SNO=(SELECT SUBSTRING(FI_SNO,1,(S_SNO-1)))+1;
		SET @DD=ID_SNO;
	SET L_SNO=(SELECT SUBSTRING(FI_SNO,(S_SNO)));
		SET @EE=L_SNO;
	SET L_SNO=(SELECT CONCAT(ID_SNO,L_SNO));
		SET @FF=L_SNO;
	SET FINAL_SNO=(SELECT CONCAT(F_SNO,'.',L_SNO));
END IF;
SET TIID=(SELECT TI_ID FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=TSIID);

-- PRICE FROM LIBRARY(MATERIAL COST)
IF TSIID=6 OR TSIID=10 OR TSIID=23 OR TSIID=30 OR TSIID=31 OR TSIID=32 OR TSIID=76 THEN
	IF MATERIAL_COST IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_MATERIAL_COST,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,MATERIAL_COST,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(LABOUR COST)
IF  TSIID=5 OR TSIID=9 OR TSIID=12 OR TSIID=13 OR TSIID=14 OR TSIID=27 OR TSIID=34 OR TSIID=35  OR TSIID=36 
OR TSIID=64 THEN
	IF LABOUR_COST IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_LABOUR_COST,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,LABOUR_COST,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(WIRING COST)
IF (TSIID BETWEEN 55 AND 61) OR (TSIID BETWEEN 100 AND 104) THEN
	IF WIRING_COST IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_WIRING_COST,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,WIRING_COST,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(MATERIAL & LABOUR COST)
IF (TSIID BETWEEN 15 AND 18) OR (TSIID BETWEEN 38 AND 52) OR (TSIID=54) OR  (TSIID BETWEEN 66 AND 69) OR (TSIID=71)
OR (TSIID=88) OR (TSIID=89) THEN
	IF MATERIAL_COST IS NOT NULL AND LABOUR_COST IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_MATERIAL_COST,IPD_LABOUR_COST,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,MATERIAL_COST,LABOUR_COST,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(CABLE PRICE)
IF  TSIID=53 THEN
	IF CABLE_PRICE IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_CABLE_PRICE,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,CABLE_PRICE,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(UNIT RATE)
IF  TSIID=130 THEN
	IF UNIT_RATE IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_UNIT_RATE,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,UNIT_RATE,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(MATERIAL & WIRING & LABOUR COST)
IF  (TSIID=73) OR (TSIID BETWEEN 78 AND 81) OR  (TSIID BETWEEN 83 AND 86) THEN
	IF MATERIAL_COST IS NOT NULL AND LABOUR_COST IS NOT NULL AND WIRING_COST IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_MATERIAL_COST,IPD_LABOUR_COST,IPD_WIRING_COST,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,MATERIAL_COST,LABOUR_COST,WIRING_COST,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;

-- PRICE FROM LIBRARY(WIRING & LABOUR COST)
IF (TSIID BETWEEN 91 AND 98) OR (TSIID BETWEEN 106 AND 108) OR (TSIID BETWEEN 110 AND 114) OR (TSIID=116) OR (TSIID BETWEEN 118 AND 122) OR
(TSIID=124) OR (TSIID BETWEEN 126 AND 129) THEN
	IF LABOUR_COST IS NOT NULL AND WIRING_COST IS NOT NULL THEN
		INSERT INTO LCE_ITEM_PRICE_DETAILS(TI_ID,TSI_ID,IPD_SNO,IPD_DESCRIPTION,PT_ID,IPD_LABOUR_COST,IPD_WIRING_COST,ULD_ID)VALUES
		(TIID,TSIID,FINAL_SNO,DESCRIPTION,PTID,LABOUR_COST,WIRING_COST,ULDID);
		SET SUCCESS_FLAG=1;
	END IF;
END IF;
	
COMMIT;
END;
