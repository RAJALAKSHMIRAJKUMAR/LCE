-- VER0.2 DATE:25/03/2015  DESC:IF(STATUS=2) MENAS NEW ROW INSERT, IF(STATUS=1) MEANS WE UPDATE IN SAME ROW done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE;
CREATE PROCEDURE SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE(
IN PROCESS VARCHAR(25),
IN TMID INTEGER,
IN PROJECT_TITLE VARCHAR(60),
IN MAIN_CONTRACTOR VARCHAR(30),
IN ARCHITECT_CONSULTANT	VARCHAR(30),
IN ME_CONSULTANT VARCHAR(30), 
IN REFERENCE_NO VARCHAR(30),
IN START_DATE DATE,
IN CLOSING_DATE	DATE, 
IN PROJECT_TYPE VARCHAR(50),
IN PRICE_TYPE VARCHAR(15),
IN REVISION_NO INTEGER,
IN PREPARED_BY VARCHAR(40),
IN CHECKED_BY VARCHAR(40),
IN APPROVED_BY VARCHAR(40),
IN USERSTAMP VARCHAR(40),
OUT SUCCESSFLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;

	DECLARE PROJECT_ID INTEGER;
	DECLARE PRICE_ID INTEGER;
	DECLARE CHECKED_BY_ID INTEGER;
	DECLARE APPROVED_BY_ID INTEGER;
	DECLARE PREPARED_BY_ID INTEGER;

	DECLARE TENDER_STATUS_ID INTEGER;
	DECLARE TENDER_STATUS INTEGER;

-- ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESSFLAG = 0;
	END;

	START TRANSACTION;

	SET AUTOCOMMIT=0;

	SET SUCCESSFLAG = 0;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	IF(CHECKED_BY = '') THEN
		SET CHECKED_BY = NULL;
	END IF;

	IF(APPROVED_BY = '') THEN
		SET APPROVED_BY = NULL;
	END IF;

	IF(TMID = '') THEN
		SET TMID = NULL;
	END IF;

	SET PRICE_ID = (SELECT PT_ID FROM LCE_PRICE_TYPE WHERE PT_TYPE = PRICE_TYPE);

	IF(CHECKED_BY IS NOT NULL OR CHECKED_BY!='') THEN
		SET CHECKED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = CHECKED_BY);
	ELSE
		SET CHECKED_BY_ID = NULL;
	END IF;

	IF(APPROVED_BY IS NOT NULL OR APPROVED_BY!='')THEN
		SET APPROVED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = APPROVED_BY);
	ELSE
		SET APPROVED_BY_ID = NULL;
	END IF;

	SET PREPARED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = PREPARED_BY);

	SET TENDER_STATUS = 1;

	IF(PROCESS = "INSERT") THEN

		IF NOT EXISTS(SELECT TM_REV_NO FROM LCE_TENDER_MANAGEMENT WHERE TM_REV_NO = REVISION_NO) THEN
		
			IF NOT EXISTS(SELECT TM_TENDER_REF_NO FROM LCE_TENDER_MANAGEMENT WHERE TM_TENDER_REF_NO = REFERENCE_NO) THEN

				IF EXISTS(SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE) THEN
					SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
				ELSE
					INSERT INTO LCE_TYPE_OF_PROJECT(TOP_TYPE) VALUES (PROJECT_TYPE);
					SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
				END IF;

				IF(PROCESS IS NOT NULL AND TMID IS NULL AND PROJECT_TITLE IS NOT NULL AND REFERENCE_NO IS NOT NULL AND MAIN_CONTRACTOR IS 
				NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS 
				NOT NULL AND TENDER_STATUS IS NOT NULL AND PROJECT_ID IS NOT NULL AND PRICE_ID IS NOT NULL AND REVISION_NO IS NOT NULL AND 
				PREPARED_BY_ID IS NOT NULL AND USERSTAMP_ID IS NOT NULL) THEN
	
					INSERT INTO LCE_TENDER_MANAGEMENT(TM_PROJECT_TITLE,TM_TENDER_REF_NO,TM_MAIN_CONTRACTOR,
					TM_ARCHITECT_CONSULTANT,TM_ME_CONSULTANT,TM_START_DATE,TM_CLOSING_DATE,TS_ID,TOP_ID,PT_ID,
					TM_REV_NO,TM_PREPARED_BY,TM_CHECKED_BY,TM_APPROVED_BY,ULD_ID) VALUES
					(PROJECT_TITLE,REFERENCE_NO,MAIN_CONTRACTOR,ARCHITECT_CONSULTANT,ME_CONSULTANT,START_DATE,
					CLOSING_DATE,TENDER_STATUS,PROJECT_ID,PRICE_ID,REVISION_NO,PREPARED_BY_ID,CHECKED_BY_ID,
					APPROVED_BY_ID,USERSTAMP_ID);
					
					SET SUCCESSFLAG = 1;
	
				END IF;
				
			END IF;

		END IF;

	END IF;

	IF(TMID IS NOT NULL) THEN

		SET TENDER_STATUS_ID = (SELECT TS_ID FROM LCE_TENDER_MANAGEMENT WHERE TM_ID = TMID);

	END IF;

	IF(PROCESS = "UPDATE") THEN

		IF(TENDER_STATUS_ID = 1) THEN

			IF EXISTS(SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE) THEN
				SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
			ELSE
				INSERT INTO LCE_TYPE_OF_PROJECT(TOP_TYPE) VALUES (PROJECT_TYPE);
				SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
			END IF;

			IF(PROCESS IS NOT NULL AND TMID IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND REFERENCE_NO IS NULL AND MAIN_CONTRACTOR IS 
			NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS 
			NOT NULL AND PROJECT_ID IS NOT NULL AND PRICE_ID IS NOT NULL AND REVISION_NO IS NULL AND PREPARED_BY_ID IS NOT NULL AND 
			USERSTAMP_ID IS NOT NULL) THEN

				UPDATE LCE_TENDER_MANAGEMENT SET TM_PROJECT_TITLE = PROJECT_TITLE,TM_MAIN_CONTRACTOR = MAIN_CONTRACTOR,
				TM_ARCHITECT_CONSULTANT = ARCHITECT_CONSULTANT,TM_ME_CONSULTANT = ME_CONSULTANT,TM_START_DATE = START_DATE,
				TM_CLOSING_DATE = CLOSING_DATE,TOP_ID = PROJECT_ID,PT_ID = PRICE_ID,TM_PREPARED_BY = PREPARED_BY_ID,
				TM_CHECKED_BY = CHECKED_BY_ID,TM_APPROVED_BY = APPROVED_BY_ID,ULD_ID = USERSTAMP_ID WHERE TM_ID = TMID;

				SET SUCCESSFLAG = 1;

			END IF;

		END IF;

		IF(TENDER_STATUS_ID = 2) THEN

			IF NOT EXISTS(SELECT TM_REV_NO FROM LCE_TENDER_MANAGEMENT WHERE TM_REV_NO = REVISION_NO) THEN

				IF NOT EXISTS(SELECT TM_TENDER_REF_NO FROM LCE_TENDER_MANAGEMENT WHERE TM_TENDER_REF_NO = REFERENCE_NO) THEN

					IF EXISTS(SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE) THEN
						SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
					ELSE
						INSERT INTO LCE_TYPE_OF_PROJECT(TOP_TYPE) VALUES (PROJECT_TYPE);
						SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
					END IF;

					IF(PROCESS IS NOT NULL AND TMID IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND REFERENCE_NO IS NOT NULL AND MAIN_CONTRACTOR IS 
					NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS 
					NOT NULL AND TENDER_STATUS IS NOT NULL AND PROJECT_ID IS NOT NULL AND PRICE_ID IS NOT NULL AND REVISION_NO IS NOT NULL 
					AND PREPARED_BY_ID IS NOT NULL AND USERSTAMP_ID IS NOT NULL) THEN

						INSERT INTO LCE_TENDER_MANAGEMENT(TM_PROJECT_TITLE,TM_TENDER_REF_NO,TM_MAIN_CONTRACTOR,
						TM_ARCHITECT_CONSULTANT,TM_ME_CONSULTANT,TM_START_DATE,TM_CLOSING_DATE,TS_ID,TOP_ID,PT_ID,
						TM_REV_NO,TM_PREPARED_BY,TM_CHECKED_BY,TM_APPROVED_BY,ULD_ID) VALUES
						(PROJECT_TITLE,REFERENCE_NO,MAIN_CONTRACTOR,ARCHITECT_CONSULTANT,ME_CONSULTANT,START_DATE,
						CLOSING_DATE,TENDER_STATUS,PROJECT_ID,PRICE_ID,REVISION_NO,PREPARED_BY_ID,CHECKED_BY_ID,
						APPROVED_BY_ID,USERSTAMP_ID);
						
						SET SUCCESSFLAG = 1;

					END IF;

				END IF;

			END IF;

		END IF;

	END IF;

	COMMIT;

END;

/* 

1. PROCESS = INSERT

CALL SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE("INSERT",NULL,'A','A','A','A','LCE/T/14/0027',
'2015-01-01','2015-01-15','Tenant fix out work','PRICE 1',3,'dhivya','','','admin',@SUCCESSFLAG);
select @SUCCESSFLAG

2. PROCESS = UPDATE & STATUS_ID = 1

CALL SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE("UPDATE",4,'A1','A1','A1','A1',NULL,
'2015-01-02','2015-01-16','Camp','PRICE 1',NULL,'admin','','','admin',@SUCCESSFLAG);
select @SUCCESSFLAG;

3. PROCESS = UPDATE & STATUS_ID = 2

CALL SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE("UPDATE",4,'A11','A11','A11','A11','LCE/T/14/0030',
'2015-01-03','2015-01-17','A111','PRICE 2',6,'admin','','','admin',@SUCCESSFLAG);
select @SUCCESSFLAG;

*/