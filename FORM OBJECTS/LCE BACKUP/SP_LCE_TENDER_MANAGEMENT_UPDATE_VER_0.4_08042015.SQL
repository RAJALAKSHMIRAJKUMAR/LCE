-- VERSION:0.4 --DATE:08/04/2015 --DESC:PROJECT TITLE, Main Contractor ,Architectural Consultant,M&E Consultant DATA TYPE CHANGED AS VARCHAR(200) --DONE BY:RL
-- VERSION:0.3 --DATE:01/04/2015 --DESC:CHANGED SP AS PER NEW TABLE DESIGN --DONEBY:RL
-- VERSION:0.2 --DATE:28/03/2015 --DESC:WHILE SAVING CHECKED PRICE TYPE SHOULD SAVE IN CORRESPONDING PROJECT TYPE DONE BY:RL
-- VER0.1 DATE:26/03/2015  DESC:SP FOR UPDATE TENDER MANAGEMENT (WRONGLY ENTERED DATAS) done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_TENDER_MANAGEMENT_UPDATE;
CREATE PROCEDURE SP_LCE_TENDER_MANAGEMENT_UPDATE(
IN LPTID INTEGER,
IN PROJECT_TITLE VARCHAR(200),
IN START_DATE DATE,
IN CLOSING_DATE DATE,
IN TMID INTEGER,
IN MAIN_CONTRACTOR VARCHAR(200),
IN ARCHITECT_CONSULTANT VARCHAR(200),
IN ME_CONSULTANT VARCHAR(200),
IN PROJECT_TYPE VARCHAR(50),
IN PRICE_TYPE VARCHAR(50),
IN PREPARED_BY VARCHAR(40),
IN CHECKED_BY VARCHAR(40),
IN APPROVED_BY VARCHAR(40),
IN USERSTAMP VARCHAR(40),
OUT SUCCESSFLAG INTEGER) 

BEGIN

	DECLARE USERSTAMP_ID INTEGER;

	DECLARE PROJECT_ID INTEGER;
	DECLARE CHECK_PROJECT_ID INTEGER;
	DECLARE PRICE_ID INTEGER;
	DECLARE PREPARED_BY_ID INTEGER;
	DECLARE CHECKED_BY_ID INTEGER;
	DECLARE APPROVED_BY_ID INTEGER;

-- ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESSFLAG = 0;
	END;

	START TRANSACTION;

	SET AUTOCOMMIT=0;

	SET SUCCESSFLAG = 0;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@USER_ID);
	SET USERSTAMP_ID=@USER_ID;

	SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);

	SET PRICE_ID = (SELECT PT_ID FROM LCE_PRICE_TYPE WHERE PT_TYPE = PRICE_TYPE);

	SET CHECK_PROJECT_ID = (SELECT TOP_ID FROM LCE_PRICE_TYPE WHERE PT_ID = PRICE_ID);

	SET PREPARED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = PREPARED_BY);

	SET CHECKED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = CHECKED_BY);

	SET APPROVED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = APPROVED_BY);

	IF(LPTID IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS NOT NULL
	AND TMID IS NOT NULL AND MAIN_CONTRACTOR IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT
	IS NOT NULL AND PROJECT_TYPE IS NOT NULL AND PRICE_TYPE IS NOT NULL AND PREPARED_BY IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

		IF(PROJECT_ID = CHECK_PROJECT_ID) THEN

			IF(LPTID IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS NOT NULL 
			AND USERSTAMP IS NOT NULL) THEN

				UPDATE LCE_PROJECT_TITLE SET LPT_PROJECT_TITLE=PROJECT_TITLE,LPT_START_DATE=START_DATE,
				LPT_CLOSING_DATE=CLOSING_DATE,ULD_ID=USERSTAMP_ID WHERE LPT_ID=LPTID;

			END IF;

			IF(TMID IS NOT NULL AND MAIN_CONTRACTOR IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT
			IS NOT NULL AND PROJECT_TYPE IS NOT NULL AND PRICE_TYPE IS NOT NULL AND PREPARED_BY IS NOT NULL AND 
			USERSTAMP IS NOT NULL) THEN

				UPDATE LCE_TENDER_MANAGEMENT SET TM_MAIN_CONTRACTOR=MAIN_CONTRACTOR,TM_ARCHITECT_CONSULTANT=ARCHITECT_CONSULTANT,
				TM_ME_CONSULTANT=ME_CONSULTANT,TOP_ID=PROJECT_ID,PT_ID=PRICE_ID,TM_PREPARED_BY=PREPARED_BY_ID,
				TM_CHECKED_BY=CHECKED_BY_ID,TM_APPROVED_BY=APPROVED_BY_ID,ULD_ID=USERSTAMP_ID WHERE TM_ID=TMID;

			END IF;

			SET SUCCESSFLAG = 1;

		END IF;

	END IF;

	COMMIT;

END;