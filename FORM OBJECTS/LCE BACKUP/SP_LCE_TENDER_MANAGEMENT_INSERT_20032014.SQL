-- VER0.1 DATE:18/03/2015  DESC:SP TO SAVE VALUES IN LCE_TENDER_MANAGEMENT TABLE done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_TENDER_MANAGEMENT_INSERT;
CREATE PROCEDURE SP_LCE_TENDER_MANAGEMENT_INSERT(
IN PROJECT_TITLE VARCHAR(60),
IN MAIN_CONTRACTOR VARCHAR(30),
IN ARCHITECT_CONSULTANT	VARCHAR(30),
IN ME_CONSULTANT VARCHAR(30),
IN REFERENCENO VARCHAR(30),
IN START_DATE DATE, 
IN CLOSING_DATE	DATE, 
IN PROJECT_TYPE VARCHAR(50),
IN PRICE_TYPE VARCHAR(15),
IN REVNO INTEGER,
IN PREPARED_BY VARCHAR(40),
IN CHECKED_BY VARCHAR(40),
IN APPROVED_BY VARCHAR(40),
IN USERSTAMP VARCHAR(40),
OUT SUCCESSFLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;

	DECLARE PROJECT_ID INTEGER;
	DECLARE PRICE_ID INTEGER;
	DECLARE TENDER_STATUS INTEGER;
	DECLARE CHECKED_BY_ID INTEGER;
	DECLARE APPROVED_BY_ID INTEGER;
-- ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESSFLAG = 0;
	END;

	START TRANSACTION;
	SET AUTOCOMMIT=0;
	SET SUCCESSFLAG = 0;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	IF(CHECKED_BY = '') THEN
		SET CHECKED_BY = NULL;
	END IF;

	IF(APPROVED_BY = '') THEN
		SET APPROVED_BY = NULL;
	END IF;

	IF EXISTS(SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE) THEN
		SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
	ELSE
		INSERT INTO LCE_TYPE_OF_PROJECT(TOP_TYPE) VALUES (PROJECT_TYPE);
		SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);
	END IF;

	SET PRICE_ID = (SELECT PT_ID FROM LCE_PRICE_TYPE WHERE PT_TYPE = PRICE_TYPE);

	SET TENDER_STATUS = 1;

	IF(CHECKED_BY IS NOT NULL OR CHECKED_BY!='') THEN
		SET CHECKED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = CHECKED_BY);
	ELSE
		SET CHECKED_BY_ID = NULL;
	END IF;

	IF(APPROVED_BY IS NOT NULL OR APPROVED_BY!='')THEN
		SET APPROVED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = APPROVED_BY);
	ELSE
		SET APPROVED_BY_ID = NULL;
	END IF;

	IF(PROJECT_TITLE IS NOT NULL AND MAIN_CONTRACTOR IS NOT NULL AND REFERENCENO IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND 
	ME_CONSULTANT IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS NOT NULL AND TENDER_STATUS IS NOT NULL AND PROJECT_ID 
	IS NOT NULL AND PRICE_ID IS NOT NULL AND REVNO IS NOT NULL AND PREPARED_BY IS NOT NULL AND USERSTAMP
	IS NOT NULL) THEN
	
		INSERT INTO LCE_TENDER_MANAGEMENT (TM_PROJECT_TITLE,TM_TENDER_REF_NO,TM_MAIN_CONTRACTOR,
		TM_ARCHITECT_CONSULTANT,TM_ME_CONSULTANT,TM_START_DATE,TM_CLOSING_DATE,TS_ID,TOP_ID,PT_ID,TM_REV_NO,TM_PREPARED_BY,
		TM_CHECKED_BY,TM_APPROVED_BY,ULD_ID) VALUES
		(PROJECT_TITLE,REFERENCENO,MAIN_CONTRACTOR,ARCHITECT_CONSULTANT,ME_CONSULTANT,START_DATE,CLOSING_DATE,
		TENDER_STATUS,PROJECT_ID,PRICE_ID,REVNO,(SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = PREPARED_BY),
		CHECKED_BY_ID,APPROVED_BY_ID,USERSTAMP_ID);

		SET SUCCESSFLAG = 1;

	END IF;

	COMMIT;

END;

/*

call SP_LCE_TENDER_MANAGEMENT_INSERT('AA','BB','CC','ARCHITECT',LCE/T/14/024','2015-01-02',
'2015-01-30','TEST1','PRICE 1','dhivya','admin','admin','admin',@SUCCESSFLAG);
select @SUCCESSFLAG;

*/