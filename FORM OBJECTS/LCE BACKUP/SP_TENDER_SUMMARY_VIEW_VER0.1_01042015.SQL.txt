-- VER 0.1 STARTDATE:01/04/2015 DESC: SP TO VIEW MARGIN DETAILS DONE BY:DHIVYA


DROP PROCEDURE IF EXISTS SP_TENDER_SUMMARY_VIEW;
CREATE PROCEDURE SP_TENDER_SUMMARY_VIEW(TMID INTEGER,MARKDOWN INTEGER,IN USERSTAMP VARCHAR(50),OUT TEMPMAINTABLE TEXT)
BEGIN
DECLARE TEMP_TABLE TEXT;
DECLARE TEMP_SUMMARY TEXT;
DECLARE MINID INTEGER;
DECLARE MAXID INTEGER;
DECLARE SUM_MAXID INTEGER;
DECLARE USERSTAMP_ID INTEGER;
DECLARE TEMPMINID INTEGER;
DECLARE TEMPMAXID INTEGER;
DECLARE IPDID INTEGER;
DECLARE TIID INTEGER;
DECLARE TEMPTABLE TEXT;
DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
	SET @DROP_TEMP_TABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPTABLE));
	PREPARE DROP_TEMP_TABLE_STMT FROM @DROP_TEMP_TABLE;
	EXECUTE DROP_TEMP_TABLE_STMT;
	SET @DROP_TEMP_TABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_SUMMARY));
	PREPARE DROP_TEMP_TABLE_STMT FROM @DROP_TEMP_TABLE;
	EXECUTE DROP_TEMP_TABLE_STMT;
END;

START TRANSACTION;
SET AUTOCOMMIT=0;

CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
SET USERSTAMP_ID=@ULD_ID;
	
	SET TEMP_TABLE=(SELECT CONCAT('TEMP_SUMMARY_DETAILS',SYSDATE()));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
	SET TEMP_TABLE=(SELECT CONCAT(TEMP_TABLE,'_',USERSTAMP_ID));
	SET TEMPTABLE=TEMP_TABLE;
	SET TEMP_TABLE=(SELECT CONCAT('TEMP_MAIN_SUMMARY_DETAILS',SYSDATE()));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,':',''));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,'-',''));
	SET TEMP_TABLE=(SELECT REPLACE(TEMP_TABLE,' ',''));
	SET TEMP_TABLE=(SELECT CONCAT(TEMP_TABLE,'_',USERSTAMP_ID));
	SET TEMPMAINTABLE=TEMP_TABLE;

	SET @DROPTABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPTABLE));
	PREPARE DROPTABLESTMT FROM @DROPTABLE;
	EXECUTE DROPTABLESTMT;
	SET @CREATETABLE=(SELECT CONCAT('CREATE TABLE ',TEMPTABLE,'(
	ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
	TEMPID TEXT,
	IPD_ID TEXT,
	TI_ID TEXT,
	TSI_ID INTEGER,
	TI_ITEMS TEXT,
	TSI_SNO TEXT,
	TSI_ITEMS TEXT,
	TMD_SNO VARCHAR(10),
	TSI_DESCRIPTION TEXT,
	TMD_QUANTITY TEXT,
	TMD_UNIT_RATE DECIMAL(7,2),
	TMD_CPF	DECIMAL(7,2),
	MATERIALCOST DECIMAL(15,2) ,
	LABOUR_COST DECIMAL(15,2) ,
	WIRING_COST DECIMAL(15,2) ,
	MARK_DOWN INTEGER,
	TENDER_MATERIAL_COST DECIMAL(15,2) ,
	TENDER_WIRING_COST DECIMAL(15,2),
	TENDER_LABOUR_COST DECIMAL(15,2) ,
	BASE_PRICE DECIMAL(15,2) ,
	TENDER_PRICE DECIMAL(15,2))'));
	PREPARE CREATETABLESTMT FROM @CREATETABLE;
	EXECUTE CREATETABLESTMT;

		SET @DROPTABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPMAINTABLE));
		PREPARE DROPTABLESTMT FROM @DROPTABLE;
		EXECUTE DROPTABLESTMT;
		SET @CREATETABLE=(SELECT CONCAT('CREATE TABLE ',TEMPMAINTABLE,'(
		ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
		TI_ITEMS TEXT,
		TSI_SNO TEXT,
		TSI_ITEMS TEXT,
		TSI_DESCRIPTION TEXT,
		MATERIALCOST DECIMAL(15,2),
		LABOUR_COST DECIMAL(15,2),
		WIRING_COST DECIMAL(15,2),
		MARK_DOWN INTEGER,
		TENDER_MATERIAL_COST DECIMAL(15,2),
		TENDER_WIRING_COST DECIMAL(15,2),
		TENDER_LABOUR_COST DECIMAL(15,2),
		BASE_PRICE DECIMAL(15,2),
		TENDER_PRICE DECIMAL(15,2),
		TMD_SNO VARCHAR(10),
		TSI_ID INTEGER,
		IPD_ID INTEGER)'));
		PREPARE CREATETABLESTMT FROM @CREATETABLE;
		EXECUTE CREATETABLESTMT;

	CALL SP_LCE_TENDER_SUMMARY_DETAILS_SEARCH(TMID,USERSTAMP,@FINALTABLENAME);
	SET TEMP_SUMMARY=(select @FINALTABLENAME);
	
	SET @SETMAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',TEMP_SUMMARY));
	PREPARE SETMAXIDSTMT FROM @SETMAXID;
	EXECUTE SETMAXIDSTMT;

	SET MAXID=@MAX_ID;
	SET SUM_MAXID=0;
	SET MINID=1;
	WHILE SUM_MAXID<MAXID DO 
		SET @SETSUM_MAXID=(SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',TEMP_SUMMARY,'  WHERE SUBITEM_SNO!="" AND ID>',MINID)) ;
		PREPARE SETSUM_MAXID_STMT FROM @SETSUM_MAXID;
		EXECUTE SETSUM_MAXID_STMT;

		IF @MIN_ID IS NOT NULL THEN
		SET SUM_MAXID=(@MIN_ID-1);
		ELSE
		SET SUM_MAXID=(MAXID+1);
		END IF;

		SET @SET_TSI_ID=(SELECT CONCAT('SELECT TSI_ID INTO @TSIID FROM ',TEMP_SUMMARY,' WHERE ID=',MINID));
		PREPARE SET_TSI_ID_STMT FROM @SET_TSI_ID;
		EXECUTE SET_TSI_ID_STMT;

		SET @INSERTQUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLE,'(TEMPID,TSI_ID,IPD_ID,TI_ID,TI_ITEMS,TSI_SNO,TSI_ITEMS,TMD_SNO,TSI_DESCRIPTION,TMD_QUANTITY,TMD_UNIT_RATE,TMD_CPF,MATERIALCOST,LABOUR_COST,WIRING_COST)
		SELECT ID,TSI_ID,IPD_ID,TI_ID,TI_ITEMS,TSI_SNO,TSI_ITEMS,TMD_SNO,TMD_DESCRIPTION,TMD_QUANTITY,TMD_UNIT_RATE,TMD_CPF,TMD_MATERIAL_COST,TMD_LABOUR_COST,TMD_WIRING_COST FROM ',TEMP_SUMMARY,' WHERE  ID BETWEEN ',MINID,' AND ',SUM_MAXID));
		PREPARE INSERTQUERYSTMT FROM @INSERTQUERY;
		EXECUTE INSERTQUERYSTMT;

		SET @SETTEMPMINID=(SELECT CONCAT('SELECT MIN(ID) INTO @TEMP_MINID FROM ',TEMPTABLE,' WHERE TSI_ID=@TSIID'));
		PREPARE SETTEMPMINIDSTMT FROM @SETTEMPMINID;
		EXECUTE SETTEMPMINIDSTMT;
		SET TEMPMINID=@TEMP_MINID ;

		SET @SETTEMPMAXID=(SELECT CONCAT('SELECT MAX(ID) INTO @TEMP_MAXID FROM ',TEMPTABLE,' WHERE TSI_ID=@TSIID'));
		PREPARE SETTEMPMAXIDSTMT FROM  @SETTEMPMAXID;
		EXECUTE SETTEMPMAXIDSTMT;
		SET TEMPMAXID=@TEMP_MAXID ;

		SET @UPDATE_COST=(SELECT CONCAT('UPDATE ',TEMPTABLE,' SET TMD_QUANTITY=IF(TMD_QUANTITY IS NOT NULL,TMD_QUANTITY,""),TMD_UNIT_RATE=IF(TMD_UNIT_RATE IS NOT NULL,TMD_UNIT_RATE,"0.00"),
			TMD_CPF=IF(TMD_CPF IS NOT NULL,TMD_CPF,"0.00"),MATERIALCOST=IF(MATERIALCOST IS NOT NULL,MATERIALCOST,"0.00"),LABOUR_COST=IF(LABOUR_COST IS NOT NULL,LABOUR_COST,"0.00"),
			WIRING_COST=IF(WIRING_COST IS NOT NULL,WIRING_COST,"0.00"),TENDER_MATERIAL_COST=IF(TENDER_MATERIAL_COST IS NOT NULL,TENDER_MATERIAL_COST,"0.00"),
			TENDER_LABOUR_COST=IF(TENDER_LABOUR_COST IS NOT NULL,TENDER_LABOUR_COST,"0.00"),TENDER_WIRING_COST=IF(TENDER_WIRING_COST IS NOT NULL,TENDER_WIRING_COST,"0.00"),
			BASE_PRICE=IF(BASE_PRICE IS NOT NULL,BASE_PRICE,"0.00"),TENDER_PRICE=IF(TENDER_PRICE IS NOT NULL,TENDER_PRICE,"0.00") WHERE TSI_DESCRIPTION!="SUB TOTAL"'));
			PREPARE UPDATE_COSTSTMT FROM @UPDATE_COST;
			EXECUTE UPDATE_COSTSTMT;

		WHILE TEMPMINID<=TEMPMAXID DO
			SET @AA=1;
			SET @SETIPDID=(SELECT CONCAT('SELECT IPD_ID INTO @TEMP_IPDID FROM ',TEMPTABLE,' WHERE ID=',TEMPMINID));
			PREPARE SETIPDIDSTMT FROM @SETIPDID;
			EXECUTE SETIPDIDSTMT;

			SET IPDID=@TEMP_IPDID;
			SET @MD=MARKDOWN;

			SET @BASEPRICE=(SELECT TMD_BASE_PRICE FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=IPDID AND TM_ID=TMID);

			SET TIID=(SELECT TI_ID FROM LCE_ITEM_PRICE_DETAILS WHERE IPD_ID=IPDID);

			IF TIID=1 THEN
				SET @UPDATE_QUERY=(SELECT CONCAT('UPDATE ',TEMPTABLE,' SET MARK_DOWN=',MARKDOWN,', MATERIALCOST=((TMD_QUANTITY*TMD_UNIT_RATE)+TMD_CPF),TENDER_MATERIAL_COST=(MATERIALCOST+(MATERIALCOST*@MD/100)),BASE_PRICE=@BASEPRICE,TENDER_PRICE=TENDER_MATERIAL_COST WHERE ID=',TEMPMINID));
				PREPARE  UPDATE_QUERY_STMT FROM @UPDATE_QUERY;
				EXECUTE UPDATE_QUERY_STMT;
			ELSEIF (TIID=11) OR (TIID=12) OR (TIID=13) THEN
				SET @UPDATE_QUERY1=(SELECT CONCAT('UPDATE ',TEMPTABLE,' SET MARK_DOWN=',MARKDOWN,', WIRING_COST=(TMD_QUANTITY*WIRING_COST),TENDER_WIRING_COST=(WIRING_COST+(WIRING_COST*@MD/100)),BASE_PRICE=@BASEPRICE,TENDER_PRICE=TENDER_WIRING_COST WHERE ID=',TEMPMINID));
				PREPARE  UPDATE_QUERY_STMT FROM @UPDATE_QUERY1;
				EXECUTE UPDATE_QUERY_STMT;
			ELSEIF (TIID=30) THEN
				SET @UPDATE_QUERY=(SELECT CONCAT('UPDATE ',TEMPTABLE,' SET MARK_DOWN=',MARKDOWN,', MATERIALCOST=TMD_UNIT_RATE,TENDER_MATERIAL_COST=(MATERIALCOST+(MATERIALCOST*@MD/100)),BASE_PRICE=@BASEPRICE,TENDER_PRICE=TENDER_MATERIAL_COST WHERE ID=',TEMPMINID));
				PREPARE  UPDATE_QUERY_STMT FROM @UPDATE_QUERY;
				EXECUTE UPDATE_QUERY_STMT;
			ELSE
			IF IPDID!=' ' THEN
				SET @QUANTITY=(SELECT TMD_QUANTITY FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=IPDID AND TM_ID=TMID);
				SET @MAT_COST=(@QUANTITY*(SELECT TMD_MATERIAL_COST FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=IPDID AND TM_ID=TMID));

				SET @UPDATE_QUERY=(SELECT CONCAT('UPDATE ',TEMPTABLE,' SET MARK_DOWN=',MARKDOWN,',MATERIALCOST=@MAT_COST,TENDER_MATERIAL_COST=((MATERIALCOST)+(MATERIALCOST*@MD/100)),TENDER_WIRING_COST=(WIRING_COST+(WIRING_COST*@MD/100)),TENDER_LABOUR_COST=(LABOUR_COST+(LABOUR_COST*@MD/100)),BASE_PRICE=@BASEPRICE,TENDER_PRICE=(TENDER_MATERIAL_COST+TENDER_WIRING_COST+TENDER_LABOUR_COST) WHERE ID=',TEMPMINID));
				PREPARE  UPDATE_QUERY_STMT FROM @UPDATE_QUERY;
				EXECUTE UPDATE_QUERY_STMT;

			END IF;
			END IF;

			

			SET @QUANTITY=NULL;
			SET TEMPMINID=TEMPMINID+1;
		END WHILE;

			SET @UPDATE_COST=(SELECT CONCAT('UPDATE ',TEMPTABLE,' SET TMD_QUANTITY=IF(TMD_QUANTITY IS NOT NULL,TMD_QUANTITY,""),TMD_UNIT_RATE=IF(TMD_UNIT_RATE IS NOT NULL,TMD_UNIT_RATE,"0.00"),
			TMD_CPF=IF(TMD_CPF IS NOT NULL,TMD_CPF,"0.00"),MATERIALCOST=IF(MATERIALCOST IS NOT NULL,MATERIALCOST,"0.00"),LABOUR_COST=IF(LABOUR_COST IS NOT NULL,LABOUR_COST,"0.00"),
			WIRING_COST=IF(WIRING_COST IS NOT NULL,WIRING_COST,"0.00"),TENDER_MATERIAL_COST=IF(TENDER_MATERIAL_COST IS NOT NULL,TENDER_MATERIAL_COST,"0.00"),
			TENDER_LABOUR_COST=IF(TENDER_LABOUR_COST IS NOT NULL,TENDER_LABOUR_COST,"0.00"),TENDER_WIRING_COST=IF(TENDER_WIRING_COST IS NOT NULL,TENDER_WIRING_COST,"0.00"),
			BASE_PRICE=IF(BASE_PRICE IS NOT NULL,BASE_PRICE,"0.00"),TENDER_PRICE=IF(TENDER_PRICE IS NOT NULL,TENDER_PRICE,"0.00") WHERE TSI_DESCRIPTION!="SUB TOTAL"'));
			PREPARE UPDATE_COSTSTMT FROM @UPDATE_COST;
			EXECUTE UPDATE_COSTSTMT;

		SET @SETTSIID=(SELECT CONCAT('SELECT DISTINCT(TSI_ID) INTO @TSID FROM ',TEMPTABLE,' WHERE TEMPID BETWEEN  ',MINID,' AND ',SUM_MAXID));
		PREPARE SETTSIIDSTMT FROM @SETTSIID;
		EXECUTE SETTSIIDSTMT;

		SET @SUMCOST=(SELECT CONCAT('SELECT SUM(MATERIALCOST),SUM(LABOUR_COST),SUM(WIRING_COST),SUM(TENDER_MATERIAL_COST),SUM(TENDER_LABOUR_COST),SUM(TENDER_WIRING_COST),SUM(BASE_PRICE),SUM(TENDER_PRICE) INTO @COST1,@COST2,@COST3,@COST4,@COST5,@COST6,@COST7,@COST8 FROM ',TEMPTABLE,' WHERE TEMPID BETWEEN  ',MINID,' AND ',SUM_MAXID));
		PREPARE SUMCOSTSTMT FROM @SUMCOST;
		EXECUTE SUMCOSTSTMT;


		SET @INSERTQUERY=(SELECT CONCAT('INSERT INTO ',TEMPTABLE,'(TEMPID,TSI_ID,IPD_ID,TI_ID,TI_ITEMS,TSI_SNO,TSI_ITEMS,TSI_DESCRIPTION,MATERIALCOST,LABOUR_COST,WIRING_COST,TENDER_MATERIAL_COST,TENDER_LABOUR_COST,TENDER_WIRING_COST,BASE_PRICE,TENDER_PRICE)
		VALUES("",@TSID,"","","","","","SUB TOTAL",@COST1,@COST2,@COST3,@COST4,@COST5,@COST6,@COST7,@COST8 )'));
		PREPARE INSERTQUERYSTMT FROM @INSERTQUERY;
		EXECUTE INSERTQUERYSTMT;
		SET @COST1=NULL;
		SET @COST2=NULL;
		SET @COST3=NULL;
		SET @COST4=NULL;
		SET @COST5=NULL;
		SET @COST6=NULL;
		SET @COST7=NULL;
		SET @COST8=NULL;

	SET MINID=(SUM_MAXID+1);
	END WHILE;

	SET @INSERT_MAIN_TABLE=(SELECT CONCAT('INSERT INTO ',TEMPMAINTABLE,'(TSI_ID,IPD_ID,TI_ITEMS,TSI_SNO,TSI_ITEMS,TMD_SNO,TSI_DESCRIPTION,MATERIALCOST,LABOUR_COST,WIRING_COST,MARK_DOWN,TENDER_MATERIAL_COST,TENDER_WIRING_COST,TENDER_LABOUR_COST,BASE_PRICE,TENDER_PRICE)
	SELECT TSI_ID,IPD_ID,TI_ITEMS,TSI_SNO,TSI_ITEMS,TMD_SNO,TSI_DESCRIPTION,MATERIALCOST,LABOUR_COST,WIRING_COST,MARK_DOWN,TENDER_MATERIAL_COST,TENDER_WIRING_COST,TENDER_LABOUR_COST,BASE_PRICE,TENDER_PRICE FROM ',TEMPTABLE));
	PREPARE INSERT_MAIN_TABLE_STMT FROM  @INSERT_MAIN_TABLE;
	EXECUTE INSERT_MAIN_TABLE_STMT;
	SET @INSERT_MAIN_TABLE=(SELECT CONCAT('INSERT INTO ',TEMPMAINTABLE,'(TSI_DESCRIPTION,MATERIALCOST,LABOUR_COST,WIRING_COST,MARK_DOWN,TENDER_MATERIAL_COST,TENDER_WIRING_COST,TENDER_LABOUR_COST,BASE_PRICE,TENDER_PRICE)
	(SELECT "TOTAL",SUM(MATERIALCOST),SUM(LABOUR_COST),SUM(WIRING_COST),MARK_DOWN,SUM(TENDER_MATERIAL_COST),SUM(TENDER_WIRING_COST),SUM(TENDER_LABOUR_COST),SUM(BASE_PRICE),SUM(TENDER_PRICE) FROM ',TEMPTABLE,' WHERE TSI_DESCRIPTION!="SUB TOTAL")'));
	PREPARE INSERT_MAIN_TABLE_STMT FROM  @INSERT_MAIN_TABLE;
	EXECUTE INSERT_MAIN_TABLE_STMT;

	SET @UPDATE_COST=(SELECT CONCAT('UPDATE ',TEMPMAINTABLE,' SET MATERIALCOST=IF(MATERIALCOST IS NOT NULL,MATERIALCOST,"0.00"),LABOUR_COST=IF(LABOUR_COST IS NOT NULL,LABOUR_COST,"0.00"),
	WIRING_COST=IF(WIRING_COST IS NOT NULL,WIRING_COST,"0.00"),TENDER_MATERIAL_COST=IF(TENDER_MATERIAL_COST IS NOT NULL,TENDER_MATERIAL_COST,"0.00"),
	TENDER_LABOUR_COST=IF(TENDER_LABOUR_COST IS NOT NULL,TENDER_LABOUR_COST,"0.00"),TENDER_WIRING_COST=IF(TENDER_WIRING_COST IS NOT NULL,TENDER_WIRING_COST,"0.00"),
	BASE_PRICE=IF(BASE_PRICE IS NOT NULL,BASE_PRICE,"0.00"),TENDER_PRICE=IF(TENDER_PRICE IS NOT NULL,TENDER_PRICE,"0.00")'));
	PREPARE UPDATE_COSTSTMT FROM @UPDATE_COST;
	EXECUTE UPDATE_COSTSTMT;

	SET @DROP_TEMP_TABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMPTABLE));
	PREPARE DROP_TEMP_TABLE_STMT FROM @DROP_TEMP_TABLE;
	EXECUTE DROP_TEMP_TABLE_STMT;
	SET @DROP_TEMP_TABLE=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_SUMMARY));
	PREPARE DROP_TEMP_TABLE_STMT FROM @DROP_TEMP_TABLE;
	EXECUTE DROP_TEMP_TABLE_STMT;

COMMIT;
END;