-- VER0.1 DATE:19/03/2015  DESC:SP TO SAVE VALUES IN LCE_TENDER_CHECKLIST TABLE done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_TENDER_CHECKLIST_INSERT;
CREATE PROCEDURE SP_LCE_TENDER_CHECKLIST_INSERT(
IN SEARCH_OPTION INTEGER,
IN TMID INTEGER,
IN CHECKLIST_ID TEXT,
IN CHECKLIST_CHECK_FLAG TEXT,
IN OTHER_DTLS TEXT,
IN OTHERDTLS_REMARKS TEXT,
IN USERSTAMP VARCHAR(50),
OUT SUCCESSFLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;
	DECLARE CHECKLISTID INTEGER;
	DECLARE CHECKLISTCHECKFLAG CHAR(1);
	DECLARE OTHERDTLS TEXT;
	DECLARE OTHERDTLSREMARKS TEXT;
	
-- ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESSFLAG = 0;
	END;

	START TRANSACTION;
	SET AUTOCOMMIT=0;
	SET SUCCESSFLAG = 0;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	SET @TEMP_CHECKLIST_ID = CHECKLIST_ID;
	SET @TEMP_CHECKLIST_CHECK_FLAG = CHECKLIST_CHECK_FLAG;
	SET @TEMP_OTHERDTLS_REMARKS = OTHERDTLS_REMARKS;
	SET @TEMP_OTHER_DTLS = OTHER_DTLS;

	IF SEARCH_OPTION=2 THEN
		SET @DELETE_TENDER_CHECKLIST=(SELECT CONCAT('DELETE FROM LCE_TENDER_CHECKLIST WHERE TM_ID=',TMID,' AND CL_ID NOT IN(',CHECKLIST_ID,')'));
		PREPARE DELETE_TENDER_CHECKLIST_STMT FROM @DELETE_TENDER_CHECKLIST;
		EXECUTE DELETE_TENDER_CHECKLIST_STMT;
	END IF;

	IF(TMID IS NOT NULL AND CHECKLIST_ID IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

		MAIN_LOOP : LOOP

			CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_CHECKLIST_ID,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO CHECKLISTID;
			SELECT @REMAINING_STRING INTO @TEMP_CHECKLIST_ID;

			CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',@TEMP_CHECKLIST_CHECK_FLAG,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO CHECKLISTCHECKFLAG;
			SELECT @REMAINING_STRING INTO @TEMP_CHECKLIST_CHECK_FLAG;

			IF(CHECKLISTCHECKFLAG='') THEN
				SET CHECKLISTCHECKFLAG = NULL;
			END IF;

			CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_OTHER_DTLS,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO OTHERDTLS;
			SELECT @REMAINING_STRING INTO @TEMP_OTHER_DTLS;

			IF(OTHERDTLS='') THEN
				SET OTHERDTLS = NULL;
			END IF;

			CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('^^',@TEMP_OTHERDTLS_REMARKS,@VALUE,@REMAINING_STRING);
			SELECT @VALUE INTO OTHERDTLSREMARKS;
			SELECT @REMAINING_STRING INTO @TEMP_OTHERDTLS_REMARKS;

			IF(OTHERDTLSREMARKS='') THEN
				SET OTHERDTLSREMARKS = NULL;
			END IF;
			
			IF (SEARCH_OPTION=1)  THEN
			
				IF NOT EXISTS(SELECT CL_ID FROM LCE_TENDER_CHECKLIST WHERE TM_ID=TMID AND CL_ID=CHECKLISTID)THEN
				
					INSERT INTO LCE_TENDER_CHECKLIST (TM_ID,CL_ID,TC_FLAG,TC_OTHER_DETAILS,TC_REMARKS,ULD_ID) VALUES
					(TMID,CHECKLISTID,CHECKLISTCHECKFLAG,OTHERDTLS,OTHERDTLSREMARKS,USERSTAMP_ID);
					SET SUCCESSFLAG = 1;
					
				END IF;
				
			END IF;
			
			IF (SEARCH_OPTION=2) THEN
			
				IF NOT EXISTS(SELECT CL_ID FROM LCE_TENDER_CHECKLIST WHERE TM_ID=TMID AND CL_ID=CHECKLISTID)THEN
					
					INSERT INTO LCE_TENDER_CHECKLIST (TM_ID,CL_ID,TC_FLAG,TC_OTHER_DETAILS,TC_REMARKS,ULD_ID) VALUES
					(TMID,CHECKLISTID,CHECKLISTCHECKFLAG,OTHERDTLS,OTHERDTLSREMARKS,USERSTAMP_ID);
					SET SUCCESSFLAG = 1;
					
				END IF;
				
				IF EXISTS(SELECT CL_ID FROM LCE_TENDER_CHECKLIST WHERE TM_ID=TMID AND CL_ID=CHECKLISTID)THEN
				
					UPDATE LCE_TENDER_CHECKLIST  SET TM_ID=TMID,TC_FLAG=CHECKLISTCHECKFLAG,TC_OTHER_DETAILS=OTHERDTLS,
					TC_REMARKS=OTHERDTLSREMARKS,ULD_ID=USERSTAMP_ID WHERE TM_ID=TMID AND CL_ID=CHECKLISTID;
					SET SUCCESSFLAG = 1;
					
				END IF;
				
			END IF;

			IF(@TEMP_CHECKLIST_ID IS NULL) THEN 
				LEAVE  MAIN_LOOP;
			END IF;

		END LOOP;

	END IF;

	COMMIT;

END;