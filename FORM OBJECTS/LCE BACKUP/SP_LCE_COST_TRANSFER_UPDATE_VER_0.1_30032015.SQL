--version:0.1 sdate:30/03/2015 --desc:cost transfer update sp --done by:rl
DROP PROCEDURE IF EXISTS SP_LCE_COST_TRANSFER_UPDATE;
CREATE PROCEDURE SP_LCE_COST_TRANSFER_UPDATE(
IN MDID TEXT,
IN SD_COSTTRANSFER TEXT,
IN SD_AFTERTRANSFER TEXT,
IN SD_REMARKS TEXT,
IN SD_TENDER_TOTAL_PRICE DECIMAL(15,2),
IN SD_AFTER_TRASFER_TOTAL_PRICE DECIMAL(15,2),
IN USERSTAMP VARCHAR(50),
OUT SUCCESSFLAG TEXT)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;

	DECLARE ID INTEGER;
	DECLARE SDCOSTTRANSFER DECIMAL(7,2);
	DECLARE SDAFTERTRANSFER DECIMAL(15,2);
	DECLARE SDREMARKS TEXT;
	DECLARE ERRORMSG TEXT;

-- ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESSFLAG = '';
	END;

	START TRANSACTION;
	SET AUTOCOMMIT=0;
	SET SUCCESSFLAG = '';

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@USER_ID);
	SET USERSTAMP_ID=@USER_ID;

	SET @TEMP_MDID = MDID;
	SET @TEMP_SD_COSTTRANSFER = SD_COSTTRANSFER;
	SET @TEMP_SD_AFTERTRANSFER = SD_AFTERTRANSFER;
	SET @TEMP_SD_REMARKS = SD_REMARKS;

	IF(SD_TENDER_TOTAL_PRICE != SD_AFTER_TRASFER_TOTAL_PRICE) THEN
		SET ERRORMSG = (SELECT EMC_DATA FROM LCE_ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID = 14);
		SET ERRORMSG = (SELECT REPLACE(ERRORMSG,'[CAMT]',SD_AFTER_TRASFER_TOTAL_PRICE));
		SET ERRORMSG = (SELECT REPLACE(ERRORMSG,'[TAMT]',SD_TENDER_TOTAL_PRICE));
		SET SUCCESSFLAG = ERRORMSG;
	END IF;

	IF(SUCCESSFLAG = '') THEN

		IF(MDID IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

			IF(SD_TENDER_TOTAL_PRICE = SD_AFTER_TRASFER_TOTAL_PRICE) THEN

				MAIN_LOOP : LOOP

					CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('~^',@TEMP_MDID,@VALUE,@REMAINING_STRING);
					SELECT @VALUE INTO ID;
					SELECT @REMAINING_STRING INTO @TEMP_MDID;

					CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('~^',@TEMP_SD_COSTTRANSFER,@VALUE,@REMAINING_STRING);
					SELECT @VALUE INTO SDCOSTTRANSFER;
					SELECT @REMAINING_STRING INTO @TEMP_SD_COSTTRANSFER;

					IF(SDCOSTTRANSFER='') THEN
						SET SDCOSTTRANSFER = NULL;
					END IF;

					CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('~^',@TEMP_SD_AFTERTRANSFER,@VALUE,@REMAINING_STRING);
					SELECT @VALUE INTO SDAFTERTRANSFER;
					SELECT @REMAINING_STRING INTO @TEMP_SD_AFTERTRANSFER;

					IF(SDAFTERTRANSFER='') THEN
						SET SDAFTERTRANSFER = NULL;
					END IF;

					CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES('~^',@TEMP_SD_REMARKS,@VALUE,@REMAINING_STRING);
					SELECT @VALUE INTO SDREMARKS;
					SELECT @REMAINING_STRING INTO @TEMP_SD_REMARKS;

					IF(SDREMARKS='') THEN
						SET SDREMARKS = NULL;
					END IF;

					UPDATE LCE_TENDER_SUMMARY_DETAILS SET TMD_COST_TRANSFER = SDCOSTTRANSFER,TMD_AFTER_TRANSFER=SDAFTERTRANSFER,
					TMD_REMARKS=SDREMARKS,ULD_ID=USERSTAMP_ID WHERE TMD_ID=ID;

					SET SUCCESSFLAG = 1;

					IF(@TEMP_MDID IS NULL) THEN 
						LEAVE  MAIN_LOOP;
					END IF;

				END LOOP;

			END IF;

		END IF;

	END IF;

	COMMIT;

END;

/*

call SP_LCE_COST_TRANSFER_UPDATE('1~^2~^3~^4','100~^200~^300~^400','400~^300~^200~^100','ee~^ee~^rrr~^fff',10000,10000,'admin',@SUCCESSFLAG);
select @SUCCESSFLAG;
*/