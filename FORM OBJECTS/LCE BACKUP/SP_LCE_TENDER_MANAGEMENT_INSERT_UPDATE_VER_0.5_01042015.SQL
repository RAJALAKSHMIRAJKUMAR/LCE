-- VERSION:0.5 --DATE:01/04/2015 --DESC:CHANGED SP AS PER NEW TABLE DESIGN --DONEBY:RL
-- VERSION:0.4 --DATE:30/03/2015 --DESC:VALIDATE REC VER SHOULD INCREMENT WITH PARTICULAR PROJECT TYPE --DONE BY :RL
-- VERSION:0.3 --DATE:28/03/2015 --DESC:WHILE SAVING CHECKED PRICE TYPE SHOULD SAVE IN CORRESPONDING PROJECT TYPE DONE BY:RL
-- VER0.2 DATE:25/03/2015  DESC:IF(STATUS=2) MENAS NEW ROW INSERT, IF(STATUS=1) MEANS WE UPDATE IN SAME ROW done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE;
CREATE PROCEDURE SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE(
IN PROCESS VARCHAR(25),
IN LPTID INTEGER,
IN PROJECT_TITLE VARCHAR(60),
IN REFERENCE_NO VARCHAR(30),
IN START_DATE DATE,
IN CLOSING_DATE DATE,
IN TMID INTEGER, 
IN MAIN_CONTRACTOR VARCHAR(30),
IN ARCHITECT_CONSULTANT VARCHAR(30),
IN ME_CONSULTANT VARCHAR(30),
IN PROJECT_TYPE VARCHAR(50),
IN PRICE_TYPE VARCHAR(50),
IN REVISION_NO INTEGER,
IN PREPARED_BY VARCHAR(40),
IN CHECKED_BY VARCHAR(40),
IN APPROVED_BY VARCHAR(40),
IN USERSTAMP VARCHAR(40),
OUT SUCCESSFLAG INTEGER)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;

	DECLARE PROJECT_ID INTEGER;
	DECLARE PRICE_ID INTEGER;
	DECLARE PREPARED_BY_ID INTEGER;
	DECLARE CHECKED_BY_ID INTEGER;
	DECLARE APPROVED_BY_ID INTEGER;

	DECLARE CHECK_PROJECT_ID INTEGER;
	DECLARE CHECK_ROW_COUNT INTEGER;
	DECLARE PROJECT_TITLE_ID INTEGER;
	DECLARE CHECK_REVISION_NO INTEGER;

	DECLARE TENDER_STATUS_ID INTEGER;

-- ROLLBACK COMMAND
	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		SET SUCCESSFLAG = 0;
	END;

	START TRANSACTION;

	SET AUTOCOMMIT=0;

	SET SUCCESSFLAG = 0;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@USER_ID);
	SET USERSTAMP_ID=@USER_ID;

	IF(LPTID='') THEN
		SET LPTID = NULL;
	END IF;

	IF(TMID='') THEN
		SET TMID = NULL;
	END IF;

	IF(CHECKED_BY='') THEN
		SET CHECKED_BY = NULL;
	END IF;

	IF(APPROVED_BY='') THEN
		SET APPROVED_BY = NULL;
	END IF;

	SET PROJECT_ID = (SELECT TOP_ID FROM LCE_TYPE_OF_PROJECT WHERE TOP_TYPE = PROJECT_TYPE);

	SET PRICE_ID = (SELECT PT_ID FROM LCE_PRICE_TYPE WHERE PT_TYPE = PRICE_TYPE);

	SET PREPARED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = PREPARED_BY);

	SET CHECKED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = CHECKED_BY);

	SET APPROVED_BY_ID = (SELECT ULD_ID FROM LCE_USER_MANAGEMENT WHERE ULD_USERNAME = APPROVED_BY);

	SET CHECK_PROJECT_ID = (SELECT TOP_ID FROM LCE_PRICE_TYPE WHERE PT_ID = PRICE_ID);

	SET CHECK_ROW_COUNT = (SELECT COUNT(*) FROM LCE_TENDER_MANAGEMENT);

	IF EXISTS(SELECT LPT_ID FROM LCE_PROJECT_TITLE WHERE LPT_PROJECT_TITLE = PROJECT_TITLE) THEN
		SET PROJECT_TITLE_ID = (SELECT LPT_ID FROM LCE_PROJECT_TITLE WHERE LPT_PROJECT_TITLE = PROJECT_TITLE);
	END IF;

	IF EXISTS (SELECT DISTINCT(LPT_ID) FROM LCE_TENDER_MANAGEMENT WHERE LPT_ID = PROJECT_TITLE_ID) THEN
	
		IF(CHECK_ROW_COUNT > 0) THEN

			SET CHECK_REVISION_NO = (SELECT MAX(TM_REV_NO) FROM LCE_TENDER_MANAGEMENT WHERE LPT_ID = PROJECT_TITLE_ID);

			SET CHECK_REVISION_NO = CHECK_REVISION_NO+1; 

		END IF;

	ELSE

		SET CHECK_REVISION_NO = 0;

	END IF;

	IF(PROCESS = 'INSERT') THEN

		IF(PROJECT_ID = CHECK_PROJECT_ID AND REVISION_NO = CHECK_REVISION_NO) THEN

			IF(PROCESS IS NOT NULL AND LPTID IS NULL AND PROJECT_TITLE IS NOT NULL AND REFERENCE_NO IS NOT NULL
			AND START_DATE IS NOT NULL AND CLOSING_DATE IS NOT NULL AND TMID IS NULL AND MAIN_CONTRACTOR IS NOT NULL
			AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND PROJECT_TYPE IS NOT NULL AND 
			PRICE_TYPE IS NOT NULL AND REVISION_NO IS NOT NULL AND PREPARED_BY IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

				IF(PROJECT_TITLE IS NOT NULL AND REFERENCE_NO IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS NOT NULL
				AND USERSTAMP IS NOT NULL) THEN

					INSERT INTO LCE_PROJECT_TITLE(LPT_PROJECT_TITLE,LPT_TENDER_REF_NO,LPT_START_DATE,LPT_CLOSING_DATE,ULD_ID) VALUES
					(PROJECT_TITLE,REFERENCE_NO,START_DATE,CLOSING_DATE,USERSTAMP_ID);

				END IF;

				IF(MAIN_CONTRACTOR IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND PROJECT_TYPE IS NOT NULL 
				AND PRICE_TYPE IS NOT NULL AND REVISION_NO IS NOT NULL AND PREPARED_BY IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

					INSERT INTO LCE_TENDER_MANAGEMENT(LPT_ID,TM_MAIN_CONTRACTOR,TM_ARCHITECT_CONSULTANT,TM_ME_CONSULTANT,
					TS_ID,TOP_ID,PT_ID,TM_REV_NO,TM_PREPARED_BY,TM_CHECKED_BY,TM_APPROVED_BY,ULD_ID) VALUES
					((SELECT LPT_ID FROM LCE_PROJECT_TITLE WHERE LPT_PROJECT_TITLE = PROJECT_TITLE),MAIN_CONTRACTOR,ARCHITECT_CONSULTANT,
					ME_CONSULTANT,1,PROJECT_ID,PRICE_ID,REVISION_NO,PREPARED_BY_ID,CHECKED_BY_ID,APPROVED_BY_ID,USERSTAMP_ID);

				END IF;

				SET SUCCESSFLAG = 1;

			END IF;

		END IF;

	END IF;

	IF(TMID IS NOT NULL) THEN

		SET TENDER_STATUS_ID = (SELECT TS_ID FROM LCE_TENDER_MANAGEMENT WHERE TM_ID = TMID);

	END IF;

	IF(PROCESS = 'UPDATE') THEN

		IF(TENDER_STATUS_ID = 1 AND PROJECT_ID = CHECK_PROJECT_ID) THEN

			IF(PROCESS IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND REFERENCE_NO IS NULL AND START_DATE IS NOT NULL 
			AND CLOSING_DATE IS NOT NULL AND MAIN_CONTRACTOR IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND 
			ME_CONSULTANT IS NOT NULL AND PROJECT_TYPE IS NOT NULL AND PRICE_TYPE IS NOT NULL AND REVISION_NO IS NULL AND 
			PREPARED_BY IS NOT NULL AND USERSTAMP IS NOT NULL) THEN

				IF(LPTID IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE AND USERSTAMP IS NOT NULL) THEN

					UPDATE LCE_PROJECT_TITLE SET LPT_PROJECT_TITLE=PROJECT_TITLE,LPT_START_DATE=START_DATE,
					LPT_CLOSING_DATE=CLOSING_DATE,ULD_ID=USERSTAMP_ID WHERE LPT_ID = LPTID;

				END IF;

				IF(TMID IS NOT NULL AND MAIN_CONTRACTOR IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND 
				PROJECT_TYPE IS NOT NULL AND PRICE_TYPE IS NOT NULL AND PREPARED_BY IS NOT NULL AND USERSTAMP IS NOT NULL
				AND REFERENCE_NO IS NULL) THEN

					UPDATE LCE_TENDER_MANAGEMENT SET TM_MAIN_CONTRACTOR=MAIN_CONTRACTOR,TM_ARCHITECT_CONSULTANT=ARCHITECT_CONSULTANT,
					TM_ME_CONSULTANT=ME_CONSULTANT,TOP_ID=PROJECT_ID,PT_ID=PRICE_ID,TM_PREPARED_BY=PREPARED_BY_ID,
					TM_CHECKED_BY=CHECKED_BY_ID,TM_APPROVED_BY=APPROVED_BY_ID,ULD_ID=USERSTAMP_ID WHERE TM_ID = TMID;

				END IF;

				SET SUCCESSFLAG = 1;

			END IF;

		END IF;

		IF(TENDER_STATUS_ID = 2 AND PROJECT_ID = CHECK_PROJECT_ID  AND REVISION_NO = CHECK_REVISION_NO) THEN

			IF(LPTID IS NOT NULL AND PROJECT_TITLE IS NOT NULL AND START_DATE IS NOT NULL AND CLOSING_DATE IS NOT NULL AND
			MAIN_CONTRACTOR IS NOT NULL AND ARCHITECT_CONSULTANT IS NOT NULL AND ME_CONSULTANT IS NOT NULL AND PROJECT_TYPE IS NOT NULL 
			AND PRICE_TYPE IS NOT NULL AND REVISION_NO IS NOT NULL AND PREPARED_BY IS NOT NULL AND USERSTAMP IS NOT NULL)THEN

				INSERT INTO LCE_TENDER_MANAGEMENT(LPT_ID,TM_MAIN_CONTRACTOR,TM_ARCHITECT_CONSULTANT,TM_ME_CONSULTANT,
				TS_ID,TOP_ID,PT_ID,TM_REV_NO,TM_PREPARED_BY,TM_CHECKED_BY,TM_APPROVED_BY,ULD_ID) VALUES
				((SELECT LPT_ID FROM LCE_PROJECT_TITLE WHERE LPT_PROJECT_TITLE = PROJECT_TITLE),MAIN_CONTRACTOR,ARCHITECT_CONSULTANT,
				ME_CONSULTANT,1,PROJECT_ID,PRICE_ID,REVISION_NO,PREPARED_BY_ID,CHECKED_BY_ID,APPROVED_BY_ID,USERSTAMP_ID);

				SET SUCCESSFLAG = 1;

			END IF;

		END IF;

	END IF;

	COMMIT;

END;

/*

1. PROCESS = INSERT

CALL SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE('INSERT',NULL,'A','LCE/T/14/0001','2014-01-01','2014-01-15',
NULL,'A','A','A','Tenant fix out work','Tenant Fix Out Work Price 2',0,'admin','','','admin',@SUCCESSFLAG);
SELECT @SUCCESSFLAG;

2. PROCESS = UPDATE & STATUS = 1

CALL SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE('UPDATE',1,'AAAA',NULL,'2014-01-02','2014-01-16',
1,'AAAA','AAAA','AAAA','Infrastructural','Infrastructural Price 2',NULL,'admin','ADMIN','admin','admin',@SUCCESSFLAG);
SELECT @SUCCESSFLAG;

3. PROCESS = UPDATE & STATUS = 2

CALL SP_LCE_TENDER_MANAGEMENT_INSERT_UPDATE('UPDATE',1,'AAAA',NULL,'2014-01-02','2014-01-16',
1,'ASD','ASD','ASD','Infrastructural','Infrastructural Price 3',1,'admin','ADMIN','admin','admin',@SUCCESSFLAG);
SELECT @SUCCESSFLAG;

*/