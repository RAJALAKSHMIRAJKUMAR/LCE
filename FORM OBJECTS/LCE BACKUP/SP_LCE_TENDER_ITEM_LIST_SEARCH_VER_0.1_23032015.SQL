-- VER0.1 DATE:23/03/2015 DESC:SP TO SHOW ALL TENDER ITEMS FOR A PROJECT done by:RL

DROP PROCEDURE IF EXISTS SP_LCE_TENDER_ITEM_LIST_SEARCH;
CREATE PROCEDURE SP_LCE_TENDER_ITEM_LIST_SEARCH(
IN TMID INTEGER,
IN USERSTAMP VARCHAR(50),
OUT FINALTABLENAME TEXT)

BEGIN

	DECLARE USERSTAMP_ID INTEGER;
	DECLARE SYSDATEANDTIME VARCHAR(50);
	DECLARE SYSDATEANDULDID VARCHAR(50);

	DECLARE TEMP_LCE_TENDER_ITEM_LIST_DTLS TEXT;
	DECLARE TEMP_ITEM_DTLS TEXT;
	DECLARE TENDER_ITEM_ID INTEGER;

	DECLARE TI_MINID INTEGER;
	DECLARE TI_MAXID INTEGER;
	DECLARE MINID INTEGER;
	DECLARE MAXID INTEGER;
	DECLARE FINALMINID INTEGER;

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
	ROLLBACK;
		IF(TEMP_LCE_TENDER_ITEM_LIST_DTLS IS NOT NULL) THEN
			SET @TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_LCE_TENDER_ITEM_LIST_DTLS));
			PREPARE TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY_STMT FROM @TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY;
			EXECUTE TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY_STMT;
		END IF;
		IF(TEMP_ITEM_DTLS IS NOT NULL) THEN
			SET @TEMP_ITEM_DTLS_DROP = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ITEM_DTLS,''));
			PREPARE TEMP_ITEM_DTLS_DROP_STMT FROM @TEMP_ITEM_DTLS_DROP;
			EXECUTE TEMP_ITEM_DTLS_DROP_STMT;
		END IF;
	END;
	
	START TRANSACTION;

-- SUB SP FOR CONVERTING USERSTAMP INTO ULDID
	CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID(USERSTAMP,@ULD_ID);
	SET USERSTAMP_ID=@ULD_ID;

	SET SYSDATEANDTIME=(SELECT SYSDATE());
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,' ',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,'-',''));
	SET SYSDATEANDTIME=(SELECT REPLACE(SYSDATEANDTIME,':',''));
	SET SYSDATEANDULDID=(SELECT CONCAT(SYSDATEANDTIME,'_',USERSTAMP_ID));

	SET TEMP_LCE_TENDER_ITEM_LIST_DTLS=(SELECT CONCAT('TEMP_LCE_TENDER_ITEM_LIST_DETAILS','_',SYSDATEANDULDID));

	SET @CREATE_TEMP_LCE_TENDER_ITEM_LIST_DTLS=(SELECT CONCAT('CREATE TABLE ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,'(
	ID INTEGER NOT NULL AUTO_INCREMENT,
	TMD_ID INTEGER,
	TMD_SNO	VARCHAR(10),
	TMD_DESCRIPTION	TEXT,
	TMD_QUANTITY INTEGER,
	TMD_UNIT_RATE DECIMAL(7,2),
	TMD_CPF	DECIMAL(7,2),
	TMD_MATERIAL_COST DECIMAL(7,2),
	TMD_WIRING_COST	DECIMAL(7,2),
	TMD_LABOUR_COST	DECIMAL(7,2),
	IPD_ID INTEGER,
	TI_ID INTEGER,
	TI_ITEMS VARCHAR(300),
	PRIMARY KEY(ID))'));
	PREPARE CREATE_TEMP_LCE_TENDER_ITEM_LIST_DTLS_STMT FROM @CREATE_TEMP_LCE_TENDER_ITEM_LIST_DTLS;
	EXECUTE CREATE_TEMP_LCE_TENDER_ITEM_LIST_DTLS_STMT;

	SET @INSERT_TEMP_LCE_TENDER_ITEM_LIST_DTLS = (SELECT CONCAT('INSERT INTO ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,'
	(TMD_ID,TMD_SNO,TMD_DESCRIPTION,TMD_QUANTITY,TMD_UNIT_RATE,TMD_CPF,TMD_MATERIAL_COST,TMD_WIRING_COST,
	TMD_LABOUR_COST,IPD_ID,TI_ID,TI_ITEMS) 
	SELECT TMD.TMD_ID,TMD.TMD_SNO,TMD.TMD_DESCRIPTION,TMD.TMD_QUANTITY,TMD.TMD_UNIT_RATE,TMD.TMD_CPF,
	TMD.TMD_MATERIAL_COST,TMD.TMD_WIRING_COST,TMD.TMD_LABOUR_COST,TMD.IPD_ID,IPD.TI_ID,TI.TI_ITEMS 
	FROM LCE_TENDER_SUMMARY_DETAILS TMD,LCE_ITEM_PRICE_DETAILS IPD,LCE_TENDER_ITEMS TI WHERE 
	TMD.TM_ID=',TMID,' AND TMD.IPD_ID=IPD.IPD_ID AND IPD.TI_ID=TI.TI_ID ORDER BY TI.TI_ID,TI.TI_ITEMS,TMD.TMD_SNO ASC'));
	PREPARE INSERT_TEMP_LCE_TENDER_ITEM_LIST_DTLS_STMT FROM @INSERT_TEMP_LCE_TENDER_ITEM_LIST_DTLS;
	EXECUTE INSERT_TEMP_LCE_TENDER_ITEM_LIST_DTLS_STMT;

	SET TEMP_ITEM_DTLS = (SELECT CONCAT('TEMP_ITEM_DETAILS','_',SYSDATEANDULDID));

	SET @CREATE_TEMP_ITEM_DTLS=(SELECT CONCAT('CREATE TABLE ',TEMP_ITEM_DTLS,'(
	ID INTEGER NOT NULL AUTO_INCREMENT,
	TI_ID INTEGER,
	PRIMARY KEY(ID))'));
	PREPARE CREATE_TEMP_ITEM_DTLS_STMT FROM @CREATE_TEMP_ITEM_DTLS;
	EXECUTE CREATE_TEMP_ITEM_DTLS_STMT;

	SET @INSERT_TEMP_ITEM_DTLS = (SELECT CONCAT('INSERT INTO ',TEMP_ITEM_DTLS,' (TI_ID)
	SELECT DISTINCT(TI_ID) FROM ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,''));
	PREPARE INSERT_TEMP_ITEM_DTLS_STMT FROM @INSERT_TEMP_ITEM_DTLS;
	EXECUTE INSERT_TEMP_ITEM_DTLS_STMT;

	SET @TIMIN_ID = (SELECT CONCAT('SELECT MIN(ID) INTO @TI_MIN_ID FROM ',TEMP_ITEM_DTLS,''));
	PREPARE TIMIN_ID_STMT FROM @TIMIN_ID;
	EXECUTE TIMIN_ID_STMT;

	SET @TIMAX_ID = (SELECT CONCAT('SELECT MAX(ID) INTO @TI_MAX_ID FROM ',TEMP_ITEM_DTLS,''));
	PREPARE TIMAX_ID_STMT FROM @TIMAX_ID;
	EXECUTE TIMAX_ID_STMT;

	SET TI_MINID = @TI_MIN_ID;
	SET TI_MAXID = @TI_MAX_ID;
	

	WHILE(TI_MINID <= TI_MAXID) DO 

		SET @SET_TENDER_ITEM_ID = (SELECT CONCAT('SELECT TI_ID INTO @SET_TENDER_ITEMID FROM ',TEMP_ITEM_DTLS,' WHERE ID = ',TI_MINID,''));
		PREPARE SET_TENDER_ITEM_ID_STMT FROM @SET_TENDER_ITEM_ID;
		EXECUTE SET_TENDER_ITEM_ID_STMT;

		SET TENDER_ITEM_ID = @SET_TENDER_ITEMID;

		SET @MINIMUMID = (SELECT CONCAT('SELECT MIN(ID) INTO @MIN_ID FROM ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,' WHERE TI_ID = ',TENDER_ITEM_ID,''));
		PREPARE MINIMUMID_STMT FROM @MINIMUMID;
		EXECUTE MINIMUMID_STMT;

		SET @MAXIMUMID = (SELECT CONCAT('SELECT MAX(ID) INTO @MAX_ID FROM ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,' WHERE TI_ID = ',TENDER_ITEM_ID,''));
		PREPARE MAXIMUMID_STMT FROM @MAXIMUMID;
		EXECUTE MAXIMUMID_STMT;

		SET MINID = @MIN_ID;
		SET MAXID = @MAX_ID;
		SET FINALMINID = MINID+1;

		SET @UPDATEQUERY = (SELECT CONCAT('UPDATE ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,' SET TI_ITEMS=""
		WHERE ID BETWEEN ',FINALMINID,' AND ',MAXID,''));
		PREPARE UPDATEQUERY_STMT FROM @UPDATEQUERY;
		EXECUTE UPDATEQUERY_STMT;

		SET TI_MINID = TI_MINID+1;

	END WHILE;

	SET FINALTABLENAME=(SELECT CONCAT('TEMP_LCE_TENDER_SUMMARY_DETAILS','_',SYSDATEANDULDID));

	SET @CREATE_FINALTABLENAME=(SELECT CONCAT('CREATE TABLE ',FINALTABLENAME,'(
	ID INTEGER NOT NULL AUTO_INCREMENT,
	TI_ITEMS VARCHAR(300),
	TMD_SNO	VARCHAR(10),
	TMD_DESCRIPTION	TEXT,
	TMD_QUANTITY INTEGER,
	TMD_UNIT_RATE DECIMAL(7,2),
	TMD_CPF	DECIMAL(7,2),
	TMD_MATERIAL_COST DECIMAL(7,2),
	TMD_WIRING_COST	DECIMAL(7,2),
	TMD_LABOUR_COST	DECIMAL(7,2),
	PRIMARY KEY(ID))'));
	PREPARE CREATE_FINALTABLENAME_STMT FROM @CREATE_FINALTABLENAME;
	EXECUTE CREATE_FINALTABLENAME_STMT;

	SET @INSERT_FINALTABLENAME = (SELECT CONCAT('INSERT INTO ',FINALTABLENAME,' (TI_ITEMS,TMD_SNO,
	TMD_DESCRIPTION,TMD_QUANTITY,TMD_UNIT_RATE,TMD_CPF,TMD_MATERIAL_COST,TMD_WIRING_COST,TMD_LABOUR_COST)
	SELECT TI_ITEMS,TMD_SNO,TMD_DESCRIPTION,TMD_QUANTITY,TMD_UNIT_RATE,TMD_CPF,TMD_MATERIAL_COST,
	TMD_WIRING_COST,TMD_LABOUR_COST FROM ',TEMP_LCE_TENDER_ITEM_LIST_DTLS,''));
	PREPARE INSERT_FINALTABLENAME_STMT FROM @INSERT_FINALTABLENAME;
	EXECUTE INSERT_FINALTABLENAME_STMT;

	IF(TEMP_LCE_TENDER_ITEM_LIST_DTLS IS NOT NULL) THEN
		SET @TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY=(SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_LCE_TENDER_ITEM_LIST_DTLS));
		PREPARE TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY_STMT FROM @TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY;
		EXECUTE TEMP_LCE_TENDER_ITEM_LIST_DTLS_DROPQUERY_STMT;
	END IF;

	IF(TEMP_ITEM_DTLS IS NOT NULL) THEN
		SET @TEMP_ITEM_DTLS_DROP = (SELECT CONCAT('DROP TABLE IF EXISTS ',TEMP_ITEM_DTLS,''));
		PREPARE TEMP_ITEM_DTLS_DROP_STMT FROM @TEMP_ITEM_DTLS_DROP;
		EXECUTE TEMP_ITEM_DTLS_DROP_STMT;
	END IF;

	COMMIT;

END;

/*
CALL SP_LCE_TENDER_ITEM_LIST_SEARCH(1,'admin',@FINALTABLENAME);
select @FINALTABLENAME
*/