-- VER 0.1 SDATE:23/4/2015 DESC: SP TO CHECK TRANSACTION TO UPDATE PRICETYPE DONE BY:DHIVYA

DROP PROCEDURE IF EXISTS SP_TENDER_PROJECT_UPDATE;
CREATE PROCEDURE SP_TENDER_PROJECT_UPDATE(
TMID INTEGER,
PRICETYPEID INTEGER,
OUT SUCCESS_FLAG TEXT,
OUT IPDID TEXT)
BEGIN
DECLARE COUNT_ID INTEGER;
DECLARE PTID INTEGER;
-- DECLARE IPDID TEXT;
DECLARE PRICE_TYPE VARCHAR(50);
DECLARE EXIT HANDLER FOR SQLEXCEPTION
BEGIN
	ROLLBACK;
SET SUCCESS_FLAG=0;

END;
START TRANSACTION;
SET AUTOCOMMIT=0;
SET PTID=(SELECT PT_ID FROM LCE_TENDER_MANAGEMENT WHERE TM_ID=TMID);
SET PRICE_TYPE=(SELECT PT_TYPE FROM LCE_PRICE_TYPE WHERE PT_ID=PRICETYPEID);

SET COUNT_ID=(SELECT COUNT(*) FROM LCE_TENDER_SUMMARY_DETAILS TMD WHERE IPD_ID IN(SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS L1 WHERE L1.IPD_SNO NOT IN
 (SELECT IPD_SNO FROM LCE_ITEM_PRICE_DETAILS WHERE PT_ID=PRICETYPEID) AND L1.PT_ID=PTID) AND TM_ID=TMID);

IF COUNT_ID=0 THEN
	SET SUCCESS_FLAG=1;
ELSE
SET IPDID=(SELECT GROUP_CONCAT(IPD_ID) FROM LCE_TENDER_SUMMARY_DETAILS TMD WHERE IPD_ID IN(SELECT IPD_ID FROM LCE_ITEM_PRICE_DETAILS L1 WHERE L1.IPD_SNO NOT IN
 (SELECT IPD_SNO FROM LCE_ITEM_PRICE_DETAILS WHERE PT_ID=PRICETYPEID) AND L1.PT_ID=PTID) AND TM_ID=TMID);
SET @SETSUCCESS_FLAG= (SELECT CONCAT('SELECT GROUP_CONCAT(IPD_SNO," ",IPD_DESCRIPTION) INTO @DESCRIPTION FROM LCE_ITEM_PRICE_DETAILS WHERE IPD_ID IN(',IPDID,')'));
PREPARE SETSUCCESS_FLAGSTMT  FROM @SETSUCCESS_FLAG;
EXECUTE SETSUCCESS_FLAGSTMT;
SET SUCCESS_FLAG=(SELECT EMC_DATA FROM LCE_ERROR_MESSAGE_CONFIGURATION WHERE EMC_ID=31);
SET SUCCESS_FLAG=(SELECT REPLACE(SUCCESS_FLAG,'[DESCRIPTION]',@DESCRIPTION));
SET SUCCESS_FLAG=(SELECT REPLACE(SUCCESS_FLAG,'[PRICE TYPE]',PRICE_TYPE));
END IF;
COMMIT;
END;