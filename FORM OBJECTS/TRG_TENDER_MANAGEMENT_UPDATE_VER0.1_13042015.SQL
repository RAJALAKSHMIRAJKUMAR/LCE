-- VER0.1 DATE:16/7/2015 DESC: TRIGGER FOR UPDATING MARGIN CALCULATION & DESCID IF PROJECT TYPE OR PRICE TYPE UPDATED DONE BY:DHIVYA

DROP TRIGGER IF EXISTS TRG_TENDER_MANAGEMENT_UPDATE;
CREATE TRIGGER TRG_TENDER_MANAGEMENT_UPDATE
AFTER UPDATE ON LCE_TENDER_MANAGEMENT
FOR EACH ROW
BEGIN
DECLARE TMID INTEGER;
DECLARE MINID INTEGER;
DECLARE MAXID INTEGER;
DECLARE TIID INTEGER;
DECLARE TSIID TEXT;
DECLARE ID INTEGER;
DECLARE SUBTOTAL DECIMAL(15,2);
DECLARE USERSTAMP_ID INTEGER;
DECLARE T_MATERIAL_COST DECIMAL(15,2);
DECLARE T_WIRING_COST DECIMAL(15,2);
DECLARE T_LABOUR_COST DECIMAL(15,2);
DECLARE MARKDOWN INTEGER;
DECLARE B_MATERIAL_COST  DECIMAL(15,2);
DECLARE B_WIRING_COST DECIMAL(15,2);
DECLARE B_LABOUR_COST DECIMAL(15,2);
CALL SP_LCE_CHANGE_USERSTAMP_AS_ULDID((SELECT ULD_USERNAME FROM LCE_USER_MANAGEMENT WHERE ULD_ID=NEW.ULD_ID),@ULD_ID);
SET USERSTAMP_ID=@ULD_ID;
IF (OLD.TOP_ID!=NEW.TOP_ID) OR (OLD.PT_ID!=NEW.PT_ID) THEN
	SET TMID=(SELECT TM_ID FROM LCE_TENDER_MANAGEMENT WHERE LPT_ID=NEW.LPT_ID AND TM_REV_NO=NEW.TM_REV_NO);
	UPDATE LCE_TENDER_SUMMARY_DETAILS TMD,LCE_ITEM_PRICE_DETAILS L1,LCE_ITEM_PRICE_DETAILS L2 SET TMD.IPD_ID=L2.IPD_ID,TMD_MATERIAL_COST=(SELECT IF(L2.IPD_MATERIAL_COST IS NOT NULL,L2.IPD_MATERIAL_COST,TMD_MATERIAL_COST)),
	TMD_WIRING_COST=(SELECT IF(L2.IPD_WIRING_COST IS NOT NULL,L2.IPD_WIRING_COST,TMD_WIRING_COST)),
	TMD_LABOUR_COST=(SELECT IF(L2.IPD_LABOUR_COST IS NOT NULL,L2.IPD_LABOUR_COST,TMD_LABOUR_COST))
	WHERE L1.PT_ID=OLD.PT_ID AND L2.PT_ID=NEW.PT_ID AND L1.IPD_SNO=L2.IPD_SNO AND L1.IPD_ID=TMD.IPD_ID AND TMD.TM_ID=TMID;

	SET MINID=(SELECT MIN(IPD_ID) FROM LCE_TENDER_SUMMARY_DETAILS WHERE TM_ID=TMID);
	SET MAXID=(SELECT MAX(IPD_ID) FROM LCE_TENDER_SUMMARY_DETAILS WHERE TM_ID=TMID);
	SET MARKDOWN=(SELECT DISTINCT TMD_MARK_DOWN FROM LCE_TENDER_SUMMARY_DETAILS WHERE TM_ID=TMID);
	WHILE MINID <= MAXID DO
		IF EXISTS(SELECT IPD_ID FROM LCE_TENDER_SUMMARY_DETAILS WHERE TM_ID=TMID AND IPD_ID=MINID) THEN
			SET TIID=(SELECT TI_ID FROM LCE_ITEM_PRICE_DETAILS WHERE IPD_ID=MINID);
			IF TIID=1 THEN
				UPDATE LCE_TENDER_SUMMARY_DETAILS SET TMD_MATERIAL_COST=(TMD_UNIT_RATE+TMD_CPF),TMD_BASE_PRICE=((TMD_QUANTITY*TMD_UNIT_RATE)+TMD_CPF),TMD_TENDER_MATERIAL_COST=(((TMD_QUANTITY*TMD_UNIT_RATE)+TMD_CPF)+((TMD_QUANTITY*TMD_UNIT_RATE)+TMD_CPF)*MARKDOWN/100),TMD_TENDER_PRICE=TMD_TENDER_MATERIAL_COST WHERE IPD_ID=MINID AND TM_ID=TMID;
			ELSEIF (TIID=11) OR (TIID=12) OR (TIID=13) THEN
				UPDATE LCE_TENDER_SUMMARY_DETAILS SET TMD_TENDER_WIRING_COST=((TMD_QUANTITY*TMD_WIRING_COST)+((TMD_QUANTITY*TMD_WIRING_COST)*MARKDOWN/100)),TMD_TENDER_PRICE=TMD_TENDER_WIRING_COST WHERE IPD_ID=MINID AND TM_ID=TMID;
			ELSEIF (TIID=30) THEN
				UPDATE LCE_TENDER_SUMMARY_DETAILS SET TMD_MATERIAL_COST=TMD_UNIT_RATE,TMD_BASE_PRICE=TMD_MATERIAL_COST,TMD_TENDER_MATERIAL_COST=((TMD_MATERIAL_COST)+(TMD_MATERIAL_COST)*MARKDOWN/100),TMD_TENDER_PRICE=TMD_TENDER_MATERIAL_COST WHERE IPD_ID=MINID AND TM_ID=TMID;
			ELSE
				UPDATE LCE_TENDER_SUMMARY_DETAILS SET TMD_TENDER_MATERIAL_COST=((TMD_QUANTITY*TMD_MATERIAL_COST)+((TMD_QUANTITY*TMD_MATERIAL_COST)*MARKDOWN/100)),TMD_TENDER_WIRING_COST=(TMD_WIRING_COST+(TMD_WIRING_COST*MARKDOWN/100)),TMD_TENDER_LABOUR_COST=(TMD_LABOUR_COST+(TMD_LABOUR_COST*MARKDOWN/100)) WHERE IPD_ID=MINID AND TM_ID=TMID;
				SET T_MATERIAL_COST=(SELECT IF(TMD_TENDER_MATERIAL_COST IS NULL,'0.00',TMD_TENDER_MATERIAL_COST) FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=MINID AND TM_ID=TMID);
				SET T_WIRING_COST=(SELECT IF(TMD_TENDER_WIRING_COST IS NULL,'0.00',TMD_TENDER_WIRING_COST) FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=MINID AND TM_ID=TMID) ;
				SET T_LABOUR_COST=(SELECT IF(TMD_TENDER_LABOUR_COST IS NULL,'0.00',TMD_TENDER_LABOUR_COST) FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=MINID AND TM_ID=TMID) ;
				SET B_MATERIAL_COST=(SELECT (TMD_QUANTITY* (SELECT IF(TMD_MATERIAL_COST IS NULL,'0.00',TMD_MATERIAL_COST))) FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=MINID AND TM_ID=TMID);
				SET B_WIRING_COST=(SELECT IF(TMD_WIRING_COST IS NULL,'0.00',TMD_WIRING_COST) FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=MINID AND TM_ID=TMID) ;
				SET B_LABOUR_COST=(SELECT IF(TMD_LABOUR_COST IS NULL,'0.00',TMD_LABOUR_COST) FROM LCE_TENDER_SUMMARY_DETAILS WHERE IPD_ID=MINID AND TM_ID=TMID) ;
				UPDATE LCE_TENDER_SUMMARY_DETAILS SET TMD_BASE_PRICE=(B_MATERIAL_COST+B_WIRING_COST+B_LABOUR_COST),TMD_TENDER_PRICE=(T_MATERIAL_COST+T_WIRING_COST+T_LABOUR_COST) WHERE IPD_ID=MINID AND TM_ID=TMID;
			END IF;
		END IF;
		SET MINID=MINID+1;
	END WHILE;

	SET TSIID=(SELECT DISTINCT(GROUP_CONCAT( TSI_ID)) FROM LCE_TENDER_SUB_ITEMS WHERE TSI_FLAG IS NULL);
	MAIN_LOOP : LOOP
	CALL SP_LCE_GET_SPECIAL_CHARACTER_SEPERATED_VALUES(',',TSIID,@VALUE,@REMAINING_STRING);
		SELECT @VALUE INTO ID;
		SELECT @REMAINING_STRING INTO TSIID;
		SET TIID=(SELECT TI_ID FROM LCE_TENDER_SUB_ITEMS WHERE TSI_ID=ID);
		SET SUBTOTAL=(SELECT SUM(TMD_TENDER_PRICE) FROM LCE_TENDER_SUMMARY_DETAILS TSD,LCE_ITEM_PRICE_DETAILS IPD WHERE TSD.TM_ID=TMID AND TSD.IPD_ID=IPD.IPD_ID AND IPD.TSI_ID=ID);
		IF SUBTOTAL IS NULL THEN
			SET SUBTOTAL=0;
		END IF;
		IF NOT EXISTS(SELECT TSI_ID FROM LCE_TENDER_SUB_TOTAL WHERE TM_ID=TMID AND TSI_ID=ID) THEN
			INSERT INTO LCE_TENDER_SUB_TOTAL(TM_ID,TI_ID,TSI_ID,TST_TENDER_PRICE,ULD_ID)VALUES
			(TMID,TIID,ID,SUBTOTAL,USERSTAMP_ID);
		ELSE
			UPDATE LCE_TENDER_SUB_TOTAL SET TST_TENDER_PRICE=SUBTOTAL,TST_AFTER_TRANSFER=(TST_TENDER_PRICE+TST_COST_TRANSFER),ULD_ID=USERSTAMP_ID WHERE TM_ID=TMID AND TSI_ID=ID AND TI_ID=TIID;
		END IF;

		IF TSIID='' IS NULL OR  TSIID='' THEN
			LEAVE  MAIN_LOOP;
		END IF;
	END LOOP;
END IF;
END;
